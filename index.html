<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blockchain Auto-Trading Bot</title>
  <meta name="theme-color" content="#0b0f14"/>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="app-logo.png">
  <link rel="apple-touch-icon" href="app-logo.png">
  <!-- Tailwind CSS CDN (utility helpers, still self-contained look) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- TradingView (chart embed) -->
  <script src="https://s3.tradingview.com/tv.js"></script>

  <!-- Ethers + Web3Modal + WalletConnect + Tron + BitcoinJS (for validations if needed) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bitcoinjs-lib@6.1.0/dist/bitcoinjs-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@4.4.0/dist/TronWeb.js"></script>

  <!-- otplib for TOTP/Google Authenticator -->
  <script src="https://cdn.jsdelivr.net/npm/otplib@12.0.1/otplib.umd.min.js"></script>
  <!-- QRious for QR code generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <style>
    /* ---------- Basic app styles (inline) ---------- */
    :root{
      --bg:#0b0f14; --panel:#0f1318; --muted:#8a8f98; --accent:#f0b90b; --card:#121316;
      --glass: rgba(255,255,255,0.02);
    }
    html,body{height:100%}
    body { background:var(--bg); color:#fff; font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; margin:0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .container{max-width:1100px;margin:0 auto}
    header, footer { background: #000000aa; backdrop-filter: blur(6px); }
    .btn { padding: .56rem .9rem; border-radius: 8px; font-weight:600; display:inline-flex; align-items:center; gap:.6rem; cursor:pointer; border:0; }
    .btn-primary { background:var(--accent); color:#111; box-shadow:0 6px 18px rgba(240,185,11,0.08); }
    .btn-secondary { background: #1f2328; color:#fff; border:1px solid rgba(255,255,255,0.03); }
    .card { background:var(--panel); border-radius:12px; border:1px solid rgba(255,255,255,0.03); padding:14px; }
    .tv-container { border-radius:10px; overflow:hidden; background:#090b0f; border:1px solid rgba(255,255,255,0.03); }
    .hide{display:none!important} .show{display:block!important}
    .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.65); z-index:60 }
    .modal-content{ background:#0e1114; padding:20px; border-radius:12px; width:96%; max-width:420px; box-shadow:0 10px 40px rgba(0,0,0,0.6); }
    .sheet{ position:fixed; left:0; right:0; bottom:0; background:linear-gradient(180deg,#0e1114,#0b0d10); border-top-left-radius:12px; border-top-right-radius:12px; padding:14px; z-index:70 }
    .input { background:#0b0d10; border:1px solid rgba(255,255,255,0.03); color:#fff; padding:.6rem .8rem; border-radius:8px; width:100% }
    .small { font-size:12px; color:var(--muted) }
    .label { display:flex; gap:.6rem; align-items:center }
    .badge { background:#101214; border-radius:999px; padding:.25rem .6rem; font-weight:600 }
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .grid-2{grid-template-columns:1fr} header .search-hide { display:none } .footer-nav { display:flex; gap:4px; } }
    .footer-nav button{ flex:1; padding:10px 6px; display:flex; flex-direction:column; align-items:center; gap:6px; background:transparent; border:0; color:#cfd3d8 }
    nav .tab-active { color:var(--accent); }
    .icon { width:20px;height:20px; display:inline-block; }
    .coin-img { width:28px;height:28px;border-radius:8px;background:#0b0d10;display:inline-flex;align-items:center;justify-content:center }
    .muted { color:var(--muted) }
    .right { text-align:right }
    .flex { display:flex; align-items:center }
    .gap-2{gap:8px}
    .mt-2{margin-top:8px}
    .mb-2{margin-bottom:8px}
  </style>
</head>
<body>

  <!-- NOTIFICATION / INSTALL PROMPT -->
  <div id="notifPop" class="hide" style="position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:120;background:#0d1113;padding:10px 16px;border-radius:10px;border:1px solid rgba(240,185,11,0.18);color:var(--accent)"></div>

  <div id="installPrompt" class="modal hide" aria-hidden="true">
    <div class="modal-content">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0">Install App</h3>
          <p class="small muted">Install the Auto-Trading Bot for a native-like experience.</p>
        </div>
        <img src="app-logo.png" alt="logo" style="width:44px;height:44px;border-radius:8px">
      </div>
      <div class="mt-2" style="display:flex;gap:10px;justify-content:flex-end">
        <button id="maybeLaterBtn" class="btn btn-secondary">Maybe later</button>
        <button id="installNowBtn" class="btn btn-primary">Install</button>
      </div>
    </div>
  </div>

  <!-- WALLET CONNECT MODAL -->
  <div id="walletModal" class="modal hide" aria-hidden="true">
    <div class="modal-content">
      <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:10px">
        <strong>Connect Wallet</strong>
        <button id="closeWalletModal" class="btn btn-secondary" title="Close">✕</button>
      </div>
      <div style="display:grid;gap:10px">
        <button id="connectMetaMask" class="btn btn-primary">
          <!-- MetaMask SVG -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="#fff" d="M..."/></svg>
          MetaMask
        </button>
        <button id="connectWalletConnect" class="btn btn-secondary">
          <svg class="icon" viewBox="0 0 24 24" fill="none"><path stroke="#fff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" d="M6 6l12 12M18 6L6 18"/></svg>
          WalletConnect
        </button>
        <button id="connectTron" class="btn btn-secondary">
          <svg class="icon" viewBox="0 0 24 24"><path d="M..." /></svg> TronLink
        </button>
        <button id="manualAddressBtn" class="btn btn-secondary">Manual Address</button>

        <div id="manualAddressInput" class="hide">
          <input id="manualInput" class="input" placeholder="Paste wallet address" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="manualConfirm" class="btn btn-primary">Confirm</button>
            <button id="manualCancel" class="btn btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="modal hide">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Login with Account ID</strong>
        <button id="closeLoginModal" class="btn btn-secondary">✕</button>
      </div>
      <div class="mt-2">
        <input id="loginInput" class="input" maxlength="10" placeholder="10-digit account ID" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="loginConfirm" class="btn btn-primary">Login</button>
          <button id="loginCancel" class="btn btn-secondary">Cancel</button>
        </div>
        <div id="loginMsg" class="small muted mt-2"></div>
      </div>
    </div>
  </div>

  <!-- Account Modal -->
  <div id="accountModal" class="modal hide">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Account</strong>
        <button id="closeAccModal" class="btn btn-secondary">✕</button>
      </div>
      <div class="mt-2 small muted">
        <div>Address</div>
        <div id="accModalAddr" style="word-break:break-all;margin:6px 0"></div>
        <div>Wallet ID</div>
        <div id="accModalId" style="margin:6px 0"></div>
        <div>Balance</div>
        <div id="accModalBal" style="margin:6px 0"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="secureAccBtn" class="btn btn-secondary">Secure (2FA)</button>
        <button id="closeAccModalBtn" class="btn btn-primary">Close</button>
      </div>
    </div>
  </div>

  <!-- Withdraw / Deposit / Swap / Trade modals are similar to above and created in DOM earlier; for brevity they exist in the DOM below -->
  <!-- MAIN HEADER -->
  <header class="container flex items-center justify-between py-3">
    <div class="flex items-center gap-3">
      <img src="app-logo.png" alt="logo" style="width:44px;height:44px;border-radius:8px" />
      <div>
        <div style="font-weight:700">Blockchain Auto-Trading Bot</div>
        <div class="small muted">Lite / Pro</div>
      </div>
    </div>

    <div class="search-hide" style="flex:1;margin:0 14px;">
      <input id="globalSearch" class="input" placeholder="Search coins, pairs or features" />
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <button id="qrBtn" class="btn btn-secondary" title="QR Scanner">
        <!-- QR SVG -->
        <svg class="icon" viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="8" height="8" rx="1" stroke="#fff"/></svg>
        Scan
      </button>

      <button id="notifBtn" class="btn btn-secondary" title="Notifications">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M15 17h5l-1.4-1.4A2 2 0 0118 14.2V11a6 6 0 00-9.3-4.9" stroke="#fff" stroke-width="1.2"/></svg>
        Alerts
      </button>

      <button id="settingsBtn" class="btn btn-secondary" title="Settings">
        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3" stroke="#fff" stroke-width="1.2"/></svg>
        Settings
      </button>

      <div style="position:relative">
        <button id="moreBtn" class="btn btn-secondary">More ▾</button>
        <div id="moreMenu" class="card hide" style="position:absolute;right:0;top:48px;width:220px">
          <a href="#" id="connectedWalletBtn" class="small muted block py-2 px-3">Connected Wallet</a>
          <a href="#" id="settingsMenuBtn" class="small muted block py-2 px-3">Settings</a>
          <a href="#" id="supportBtn" class="small muted block py-2 px-3">Support</a>
          <a href="#" id="disconnectBtn" class="small muted block py-2 px-3">Disconnect</a>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN PAGES (SPA) -->
  <main class="container" id="appMain" style="padding-bottom:120px;margin-top:18px">

    <!-- LANDING PAGE -->
    <section id="landingPage" class="page">
      <div style="text-align:center;margin-top:30px">
        <img src="app-logo.png" style="width:96px;height:96px;border-radius:12px" alt="logo" />
        <h1 style="color:var(--accent);margin-top:8px">Blockchain Auto-Trading Bot</h1>
        <p class="muted" style="max-width:760px;margin:8px auto">Automate trading with on-chain precision and AI-driven strategies. Connect your wallet, configure risk controls, and run simulated trading — all in a secure interface.</p>

        <div style="display:flex;gap:10px;justify-content:center;margin-top:14px">
          <button id="connectWalletBtn" class="btn btn-primary">Connect Wallet</button>
          <button id="loginIdBtn" class="btn btn-secondary">Login ID</button>
          <button id="getMobileAppBtn" class="btn btn-primary">Get Mobile App</button>
        </div>

        <div style="max-width:760px;margin:16px auto">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="small muted">Wallet status</div>
                <div id="walletText">Wallet not connected</div>
              </div>
              <div style="text-align:right">
                <div class="small muted">Total Balance</div>
                <div id="totalBalance" style="font-weight:700">$8,250.78</div>
              </div>
            </div>
          </div>
        </div>

        <div style="max-width:1100px;margin:20px auto">
          <h3 style="margin-bottom:8px">Market Overview</h3>
          <div id="landingMarket" class="card" style="min-height:120px"></div>

          <h3 style="margin-top:18px">Top Coins</h3>
          <div id="landingTopCoins" class="grid-2 mt-2"></div>
        </div>

      </div>
    </section>

    <!-- HOME PAGE -->
    <section id="home" class="page hide">
      <div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small muted">Wallet ID</div>
          <div id="walletId" style="font-weight:700">—</div>
        </div>
        <div class="right">
          <div class="small muted">Main Balance</div>
          <div id="mainBalance" style="font-weight:700">$8,250.78</div>
          <div class="small muted">Trade Balance</div>
          <div id="tradeBalance" style="font-weight:600">$0.00</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="depositBtn" class="btn btn-primary">Deposit</button>
        <button id="transferBtn" class="btn btn-secondary">Transfer to Trade</button>
        <button id="withdrawBtn" class="btn btn-primary">Withdraw</button>
      </div>

      <div style="margin-top:12px" class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:10px;align-items:center">
            <div class="coin-img"><img id="usdtLogo" src="" alt="usdt" style="width:24px;height:24px;border-radius:6px"/></div>
            <div>
              <div style="font-weight:700">Tether USD (USDT)</div>
              <div id="usdtPrice" class="small muted">$1.00</div>
            </div>
          </div>
          <div class="small muted">BTC / USDT</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h3>Live Market</h3>
        <div class="tv-container" id="tvchart" style="height:320px"></div>
      </div>

      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Top Coins</div>
            <button id="refreshMarkets" class="btn btn-secondary">Refresh</button>
          </div>
          <div id="topCoinsList" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Gainers & Losers</div>
            <div class="small muted">24h</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
            <div id="gainers"></div><div id="losers"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- MARKETS PAGE -->
    <section id="markets" class="page hide">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Markets</h2>
        <div class="small muted">Spot</div>
      </div>
      <div class="card mt-2">
        <div style="display:flex;gap:8px">
          <input id="marketSearch" class="input" placeholder="Search (e.g., bitcoin, eth)" />
          <button id="marketRefresh" class="btn btn-secondary">Refresh</button>
        </div>
        <div id="marketsList" style="margin-top:12px;max-height:56vh;overflow:auto"></div>
      </div>
    </section>

    <!-- SWAP PAGE -->
    <section id="SwapPage" class="page hide">
      <h2>Swap (simulated)</h2>
      <div class="card">
        <div style="display:flex;gap:8px">
          <select id="swapFromCoin" class="input"></select>
          <button id="swapSwitchBtn" class="btn btn-secondary">⇅</button>
          <select id="swapToCoin" class="input"></select>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="swapAmount" class="input" placeholder="Amount" />
          <button id="swapBtnSwapPage" class="btn btn-primary">Swap</button>
        </div>
        <div id="swapRate" class="small muted mt-2"></div>
        <div id="swapResult" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- TRADE PAGE -->
    <section id="trade" class="page hide">
      <h2>Trade</h2>
      <div id="mt5DashboardSection"></div>

      <div class="card mt-2">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Trade Account</div>
          <div class="small muted">Use Transfer on Home to add funds</div>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <select id="tradeSymbol" class="input" style="max-width:220px">
            <option value="BINANCE:BTCUSDT">BTC/USDT</option>
            <option value="BINANCE:ETHUSDT">ETH/USDT</option>
            <option value="BINANCE:BNBUSDT">BNB/USDT</option>
          </select>
          <button id="loadSymbol" class="btn btn-secondary">Load Chart</button>
        </div>

        <div id="tradeChart" class="tv-container" style="height:320px;margin-top:12px"></div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="placeTradeBtn" class="btn btn-primary">Place Trade (All funds)</button>
          <button id="viewEarningsBtn" class="btn btn-secondary">View Earnings</button>
        </div>

        <div id="tradeActiveTradesList" class="small muted mt-3">No active trades</div>
      </div>
    </section>

    <!-- FUTURES PAGE -->
    <section id="futures" class="page hide">
      <h2>Futures (simulated)</h2>
      <div class="tv-container" id="futuresChart" style="height:420px;margin-top:12px"></div>
      <div class="card mt-2">
        <div id="futuresList" class="small muted">No futures data — demo mode.</div>
      </div>
    </section>

    <!-- WALLETS PAGE -->
    <section id="wallets" class="page hide">
      <h2>Wallets</h2>
      <div class="card mt-2">
        <div style="display:flex;justify-content:space-between">
          <div>
            <div class="small muted">Wallet ID</div>
            <div id="walletId2" style="font-weight:700">—</div>
          </div>
          <div class="right">
            <div class="small muted">Main Balance</div>
            <div id="totalBalance2" style="font-weight:700">$8,250.78</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="font-weight-700">Holdings</div>
          <div id="walletHoldings" class="small muted mt-2">No holdings</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS PAGE -->
    <section id="settingsPage" class="page hide">
      <h2>Settings</h2>
      <div class="card mt-2">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>Enable Notifications</div>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="notifToggle" />
            <span class="small muted" id="notifToggleLabel">Off</span>
          </label>
        </div>

        <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
          <div>Theme</div>
          <select id="themeSelect" class="input" style="max-width:160px">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select>
        </div>

        <div style="margin-top:12px">
          <button id="closeAccountBtn" class="btn btn-primary">Close Account (2FA required)</button>
        </div>
      </div>
    </section>

    <!-- SUPPORT -->
    <section id="supportPage" class="page hide">
      <h2>Support</h2>
      <div class="card mt-2">
        <div class="font-weight-700">FAQs</div>
        <div class="small muted mt-2">
          <div><b>How to connect?</b> Use Connect Wallet on landing or header.</div>
          <div class="mt-1"><b>How to add funds?</b> Use Transfer to move funds to trade account.</div>
        </div>
      </div>

      <div class="card mt-2">
        <div style="font-weight:700">Live Support AI Bot</div>
        <div id="supportChatBox" style="height:180px;overflow:auto;background:#0b0d10;padding:8px;border-radius:8px;margin-top:8px"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="supportUserMsg" class="input" placeholder="Type message..." />
          <button id="supportSendBtn" class="btn btn-primary">Send</button>
        </div>
      </div>
    </section>

    <!-- NOTIFICATIONS -->
    <section id="notifPage" class="page hide">
      <h2>Notifications</h2>
      <div id="notifList" class="card mt-2 small muted">No notifications yet.</div>
    </section>

  </main>

  <!-- FOOTER NAV -->
  <footer class="fixed bottom-0 left:0 right:0" style="background:#060708;padding:6px 0;box-shadow:0 -6px 24px rgba(0,0,0,0.6)">
    <nav class="container footer-nav" style="display:flex;gap:6px;align-items:center">
      <button class="tab tab-home" data-target="home" aria-label="Home">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 9.5L12 3l9 6.5V21a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z" stroke="#cfd3d8"/></svg>
        <span class="small muted">Home</span>
      </button>
      <button class="tab tab-markets" data-target="markets" aria-label="Markets">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 3v18h18" stroke="#cfd3d8"/></svg>
        <span class="small muted">Markets</span>
      </button>
      <button class="tab tab-trade" data-target="trade" aria-label="Trade">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 12h18M12 3v18" stroke="#cfd3d8"/></svg>
        <span class="small muted">Trade</span>
      </button>
      <button class="tab tab-futures" data-target="futures" aria-label="Futures">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 2v20" stroke="#cfd3d8"/></svg>
        <span class="small muted">Futures</span>
      </button>
      <button class="tab tab-wallets" data-target="wallets" aria-label="Wallets">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><rect x="2" y="6" width="20" height="12" rx="2" stroke="#cfd3d8"/></svg>
        <span class="small muted">Wallets</span>
      </button>
    </nav>
  </footer>

  <!-- Inline service-worker code will be registered from this page -->
  <script>
  /* ---------- App constants and state ---------- */
  const TOTAL_BALANCE = 8250.78;
  const USDT_DECIMALS = 6;
  const LS = {
    user: "autoTrade_user",
    walletMap: "autoTrade_walletMap",
    transactions: "autoTrade_transactions",
    withdraws: "autoTrade_withdrawals",
    withdrawSusp: "autoTrade_withdrawSusp",
    trades: "autoTrade_trades",
    notif: "autoTrade_notif",
    coinCache: "autoTrade_coinCache",
    lastPage: "autoTrade_lastPage",
    tradingSimulation: "tradingSimulation"
  };

  let app = {
    provider: null,
    web3Provider: null,
    signer: null,
    address: null,
    chainId: null,
    mainBalance: TOTAL_BALANCE,
    tradeBalance: 0,
    marketTop: [],
    coinCache: [],
    isConnected: false
  };

  /* ---------- Helpers ---------- */
  function $(sel){ return document.querySelector(sel); }
  function $all(sel){ return Array.from(document.querySelectorAll(sel)); }
  function fmtUsd(n){ return typeof n==="number" ? n.toLocaleString('en-US',{style:'currency',currency:'USD'}) : n; }
  function saveLS(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function getLS(k, fallback=null){ try{const v = JSON.parse(localStorage.getItem(k)); return v===null?fallback:v||fallback;}catch(e){return fallback;} }
  function setLastPage(page){ saveLS(LS.lastPage, page); }
  function getLastPage(){ return getLS(LS.lastPage, null); }
  function notify(msg, timeout=3000){ const el = $('#notifPop'); if(!el) return; el.textContent = msg; el.classList.remove('hide'); setTimeout(()=>el.classList.add('hide'), timeout); }

  /* ---------- SPA page switching ---------- */
  function switchPage(pageId, skipPersist=false){
    $all('.page').forEach(p=>p.classList.add('hide'));
    const target = document.getElementById(pageId);
    if(target) target.classList.remove('hide');
    if(!skipPersist) setLastPage(pageId);
    window.scrollTo(0,0);
    // wire some page-specific actions
    if(pageId === 'home') loadUsdt();
    if(pageId === 'markets') loadMarkets();
    if(pageId === 'landingPage') loadLanding();
  }
  // footer/tab wiring
  $all('.tab').forEach(t=>t.addEventListener('click',()=>{ const tgt=t.dataset.target; if(tgt) switchPage(tgt); $all('.tab').forEach(x=>x.classList.remove('tab-active')); t.classList.add('tab-active'); }));

  /* ---------- Web3Modal + Ethers setup ---------- */
  let web3Modal;
  let providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider?.default || window.WalletConnectProvider,
      options: {
        rpc: {
          // public fallback rpc endpoints; replace with your own provider endpoints for reliability in production
          1: "https://cloudflare-eth.com",
          56: "https://bsc-dataseed.binance.org/",
          137: "https://rpc-mainnet.maticvigil.com/"
        }
      }
    }
  };

  function initWeb3Modal(){
    web3Modal = new window.Web3Modal.default({
      cacheProvider: true,
      providerOptions
    });
  }

  async function connectWallet(){
    try{
      const provider = await web3Modal.connect();
      app.provider = provider;
      app.web3Provider = new ethers.providers.Web3Provider(provider);
      app.signer = app.web3Provider.getSigner();
      const addr = await app.signer.getAddress();
      app.address = addr;
      app.chainId = (await app.web3Provider.getNetwork()).chainId;
      app.isConnected = true;
      saveLS(LS.user, { address: app.address, chainId: app.chainId });
      // handle provider events
      provider.on && provider.on("accountsChanged", (accounts)=>{ if(accounts && accounts.length) { app.address = accounts[0]; saveLS(LS.user,{address:app.address,chainId:app.chainId}); updateUIOnConnect(); } else { disconnectWallet(); } });
      provider.on && provider.on("chainChanged", (chainId)=>{ app.chainId = parseInt(chainId, 16); saveLS(LS.user,{address:app.address,chainId:app.chainId}); updateUIOnConnect(); });
      provider.on && provider.on("disconnect", ()=>{ disconnectWallet(); });
      updateUIOnConnect();
      notify("Wallet connected");
      return true;
    }catch(err){
      console.warn("connectWallet error", err);
      notify("Wallet connection failed");
      return false;
    }
  }

  async function tryAutoConnect(){
    initWeb3Modal();
    if(web3Modal?.cachedProvider){
      await connectWallet();
    } else {
      // check localStorage saved entry (fallback)
      const u = getLS(LS.user, null);
      if(u && u.address){
        app.address = u.address;
        app.chainId = u.chainId || null;
        app.isConnected = true;
        updateUIOnConnect();
      }
    }
  }

  function disconnectWallet(){
    if(web3Modal){
      web3Modal.clearCachedProvider && web3Modal.clearCachedProvider();
    }
    // try to disconnect provider if it supports close/killSession
    if(app.provider && app.provider.disconnect) try{ app.provider.disconnect(); }catch(e){}
    app.provider = null; app.web3Provider = null; app.signer = null; app.address = null; app.chainId = null; app.isConnected=false;
    localStorage.removeItem(LS.user);
    notify("Disconnected");
    updateUIOnConnect();
    // Keep user on landing page
    switchPage('landingPage');
  }

  /* ---------- UI update on connect ---------- */
  function updateUIOnConnect(){
    if(app.address){
      $('#walletText').textContent = "Connected: " + shortAddr(app.address);
      $('#walletId').textContent = shortAddr(app.address);
      $('#walletId2').textContent = shortAddr(app.address);
      $('#accModalAddr').textContent = app.address;
      $('#accModalId').textContent = app.address;
      $('#disconnectBtn').classList.remove('hide');
      $('#connectWalletBtn').textContent = "Wallet connected";
    } else {
      $('#walletText').textContent = "Wallet not connected";
      $('#walletId').textContent = "—";
      $('#walletId2').textContent = "—";
      $('#accModalAddr').textContent = "";
      $('#accModalId').textContent = "";
      $('#disconnectBtn').classList.add('hide');
      $('#connectWalletBtn').textContent = "Connect Wallet";
    }
    // balances
    $('#mainBalance').textContent = fmtUsd(app.mainBalance);
    $('#tradeBalance').textContent = fmtUsd(app.tradeBalance);
    $('#totalBalance').textContent = fmtUsd(app.mainBalance);
    $('#totalBalance2').textContent = fmtUsd(app.mainBalance);
    $('#accModalBal').textContent = fmtUsd(app.mainBalance);
    // show/hide wallet modal if open
  }

  function shortAddr(a){
    if(!a) return "";
    if(a.startsWith("0x")) return a.slice(0,6)+"..."+a.slice(-4);
    return a.slice(0,6)+"..."+a.slice(-4);
  }

  /* ---------- CoinGecko Market data ---------- */
  const COINGECKO_BASE = 'https://api.coingecko.com/api/v3';

  async function loadUsdt(){
    try{
      const res = await fetch(`${COINGECKO_BASE}/coins/tether`);
      const data = await res.json();
      if(data?.image?.thumb) $('#usdtLogo').src = data.image.thumb;
      const markets = await fetch(`${COINGECKO_BASE}/coins/markets?vs_currency=usd&ids=tether`).then(r=>r.json());
      if(markets && markets[0] && $('#usdtPrice')) $('#usdtPrice').textContent = fmtUsd(markets[0].current_price);
    }catch(e){ console.warn("USDT load failed", e); }
  }

  async function loadMarkets(){
    try{
      const url = `${COINGECKO_BASE}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1&sparkline=false&price_change_percentage=24h`;
      const data = await fetch(url).then(r=>r.json());
      app.marketTop = data;
      // top coins on home
      if($('#topCoinsList')) $('#topCoinsList').innerHTML = data.slice(0,8).map(c=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.02)"><div style="display:flex;gap:8px;align-items:center"><img src="${c.image}" style="width:28px;height:28px;border-radius:6px"/><div><div style="font-weight:600">${c.name}</div><div class="small muted">${c.symbol.toUpperCase()}</div></div></div><div class="right">${fmtUsd(c.current_price)}<div class="${c.price_change_percentage_24h>=0?'small' : 'small'}">${(c.price_change_percentage_24h||0).toFixed(2)}%</div></div></div>`).join('');
      // landing top coins
      if($('#landingTopCoins')) {
        const el = $('#landingTopCoins'); el.innerHTML = "";
        data.slice(0,8).forEach(c=>{
          const div = document.createElement('div');
          div.className = 'card';
          div.style.display = 'flex'; div.style.justifyContent = 'space-between'; div.style.alignItems='center';
          div.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><img src="${c.image}" style="width:36px;height:36px;border-radius:8px"/><div><div style="font-weight:700">${c.name}</div><div class="small muted">${c.symbol.toUpperCase()}</div></div></div><div class="right">${fmtUsd(c.current_price)}<div class="small muted">${(c.price_change_percentage_24h||0).toFixed(2)}%</div></div>`;
          el.appendChild(div);
        });
      }
      // gainers & losers
      const sorted = data.slice().sort((a,b)=>(b.price_change_percentage_24h||0)-(a.price_change_percentage_24h||0));
      if($('#gainers')) $('#gainers').innerHTML = sorted.slice(0,4).map(c=>`<div class="small"><strong>${c.symbol.toUpperCase()}</strong> ${fmtUsd(c.current_price)} <span class="muted">${(c.price_change_percentage_24h||0).toFixed(1)}%</span></div>`).join('');
      if($('#losers')) $('#losers').innerHTML = sorted.slice(-4).reverse().map(c=>`<div class="small"><strong>${c.symbol.toUpperCase()}</strong> ${fmtUsd(c.current_price)} <span class="muted">${(c.price_change_percentage_24h||0).toFixed(1)}%</span></div>`).join('');
    }catch(e){ console.warn("loadMarkets error", e); }
  }

  async function loadLanding(){
    // reuse loadMarkets and show a summary
    await loadMarkets();
    if(app.marketTop && $('#landingMarket')){
      const top = app.marketTop.slice(0,5);
      $('#landingMarket').innerHTML = `<div style="display:flex;gap:12px;align-items:center">${top.map(c=>`<div style="display:flex;flex-direction:column;align-items:center"><img src="${c.image}" style="width:36px;height:36px;border-radius:8px"/><div class="small muted">${c.symbol.toUpperCase()}</div><div>${fmtUsd(c.current_price)}</div></div>`).join('')}</div>`;
    }
  }

  /* ---------- TradingView chart init ---------- */
  function initializeTradingView(){
    try{
      if(typeof TradingView === 'undefined') return;
      const el = document.getElementById('tvchart');
      if(!el) return;
      new TradingView.widget({
        width: "100%",
        height: 320,
        symbol: "BINANCE:BTCUSDT",
        interval: "D",
        timezone: "Etc/UTC",
        theme: "dark",
        style: "1",
        locale: "en",
        container_id: "tvchart"
      });
    }catch(e){ console.warn("TradingView init failed", e); }
  }

  function embedTradeChart(symbol, containerId='tradeChart'){
    try{
      if(typeof TradingView === 'undefined') return;
      const el = document.getElementById(containerId);
      if(!el) return;
      el.innerHTML = '';
      const wrapper = document.createElement('div'); wrapper.id = 'tvwidget_' + containerId; wrapper.style.height = '340px';
      el.appendChild(wrapper);
      new TradingView.widget({
        container_id: wrapper.id,
        autosize: true,
        symbol,
        interval: "D",
        timezone: "Etc/UTC",
        theme: "dark",
        style: "1",
        locale: "en"
      });
    }catch(e){ console.warn("embedTradeChart err", e); }
  }

  /* ---------- Trade logic: Transfer only ---------- */
  function transferToTrade(amount){
    if(isNaN(amount) || amount <= 0) return alert("Enter a valid amount");
    if(amount > app.mainBalance) return alert("Insufficient main balance");
    app.mainBalance -= amount;
    app.tradeBalance += amount;
    saveState();
    updateUIOnConnect();
    notify(`Transferred ${fmtUsd(amount)} to trade account`);
  }

  function placeTradeAll(){
    if(app.tradeBalance <= 0) return alert("No funds in trade account");
    // simulate placing a trade with all trade balance
    const trades = getLS(LS.trades, []);
    const trade = { id: Date.now(), symbol: $('#tradeSymbol').value, amount: app.tradeBalance, start: Date.now(), status: 'active' };
    trades.push(trade);
    saveLS(LS.trades, trades);
    app.tradeBalance = 0;
    saveState();
    renderActiveTrades();
    notify("Trade placed with all trade funds");
  }

  function renderActiveTrades(){
    const trades = getLS(LS.trades, []);
    if(!trades || !trades.length){
      $('#tradeActiveTradesList').textContent = "No active trades";
      return;
    }
    $('#tradeActiveTradesList').innerHTML = trades.filter(t=>t.status==='active').map(t=>`${t.symbol} — ${fmtUsd(t.amount)} (started: ${new Date(t.start).toLocaleString()})`).join('\n');
  }

  /* ---------- Persistence ---------- */
  function saveState(){
    saveLS('autoTrade_balances', { mainBalance: app.mainBalance, tradeBalance: app.tradeBalance });
  }
  function restoreState(){
    const st = getLS('autoTrade_balances', null);
    if(st){ app.mainBalance = st.mainBalance ?? app.mainBalance; app.tradeBalance = st.tradeBalance ?? app.tradeBalance; }
  }

  /* ---------- Utilities ---------- */
  function getLS(key, fallback){ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):fallback;}catch(e){return fallback;} }
  function short(a){ if(!a) return ""; return a.slice(0,6)+"..."+a.slice(-4); }

  /* ---------- Event wiring ---------- */
  document.addEventListener('DOMContentLoaded', async ()=>{
    // init web3modal
    initWeb3Modal();
    await tryAutoConnect();
    restoreState();
    updateUIOnConnect();
    loadUsdt(); loadMarkets();
    initializeTradingView();
    renderActiveTrades();

    // restore last page
    const last = getLastPage() || 'landingPage';
    switchPage(last, true);

    // wire header buttons
    $('#connectWalletBtn').onclick = ()=>{ $('#walletModal').classList.remove('hide'); };
    $('#closeWalletModal').onclick = ()=>{ $('#walletModal').classList.add('hide'); };
    $('#connectMetaMask').onclick = async ()=>{ $('#manualAddressInput').classList.add('hide'); await connectWallet(); $('#walletModal').classList.add('hide'); };
    $('#connectWalletConnect').onclick = async ()=>{ $('#manualAddressInput').classList.add('hide'); await connectWallet(); $('#walletModal').classList.add('hide'); };
    $('#manualAddressBtn').onclick = ()=>{ $('#manualAddressInput').classList.remove('hide'); };
    $('#manualConfirm').onclick = ()=>{ const v = $('#manualInput').value.trim(); if(v.length>6){ app.address=v; app.isConnected=true; saveLS(LS.user,{address:v}); updateUIOnConnect(); $('#walletModal').classList.add('hide'); notify("Manual address saved"); } else alert("Enter valid address"); };
    $('#manualCancel').onclick = ()=>{ $('#manualAddressInput').classList.add('hide'); };

    $('#connectedWalletBtn').onclick = (e)=>{ e.preventDefault(); $('#walletModal').classList.remove('hide'); };
    $('#disconnectBtn').onclick = async ()=>{ disconnectWallet(); };

    $('#loginIdBtn').onclick = ()=>{ $('#loginModal').classList.remove('hide'); };
    $('#closeLoginModal').onclick = ()=>{ $('#loginModal').classList.add('hide'); };
    $('#loginCancel').onclick = ()=>{ $('#loginModal').classList.add('hide'); };
    $('#loginConfirm').onclick = async ()=>{
      const v = $('#loginInput').value.trim();
      if(!/^\d{10}$/.test(v)){ $('#loginMsg').textContent = "Enter a valid 10-digit ID"; return; }
      $('#loginMsg').textContent = "Logging in..."; await new Promise(r=>setTimeout(r,1200));
      $('#loginMsg').textContent = "Logged in (demo)"; $('#loginModal').classList.add('hide'); notify("Logged in");
    };

    // page nav via more menu
    $('#moreBtn').onclick = ()=>{ $('#moreMenu').classList.toggle('hide'); };
    document.addEventListener('click', (ev)=>{ if(!ev.target.closest('#moreBtn') && !ev.target.closest('#moreMenu')) $('#moreMenu').classList.add('hide'); });

    // home actions
    $('#depositBtn').onclick = ()=>{ switchPage('SwapPage'); notify("Deposit (simulated) — use Swap or external"); };
    $('#transferBtn').onclick = async ()=>{
      let amt = prompt("Amount to transfer to Trade account (USD):", "100");
      if(!amt) return; amt = parseFloat(amt);
      if(isNaN(amt)) return alert("Invalid amount");
      transferToTrade(amt);
    };
    $('#withdrawBtn').onclick = ()=>{ alert("Open Withdraw modal (demo)"); };

    $('#refreshMarkets').onclick = ()=>{ loadMarkets(); notify("Markets refreshed"); };

    // swap
    $('#swapBtnSwapPage').onclick = async ()=>{
      const from = $('#swapFromCoin').value; const to = $('#swapToCoin').value; const amt = parseFloat($('#swapAmount').value);
      if(!amt || amt<=0) return alert("Enter amount");
      // simple simulated swap using CoinGecko
      const markets = await fetch(`${COINGECKO_BASE}/simple/price?ids=${from},${to}&vs_currencies=usd`).then(r=>r.json());
      const fromUsd = markets[from]?.usd || 0; const toUsd = markets[to]?.usd || 0;
      if(!fromUsd || !toUsd) return alert("Rate unavailable");
      const received = (amt * fromUsd) / toUsd;
      $('#swapResult').textContent = `Estimated receive: ${received.toFixed(6)} ${to.toUpperCase()}`;
      notify("Swap estimated (simulated)");
    };

    // trade actions
    $('#loadSymbol').onclick = ()=>{ embedTradeChart($('#tradeSymbol').value, 'tradeChart'); };
    $('#placeTradeBtn').onclick = ()=>{ if(confirm("Place trade using all trade funds?")) placeTradeAll(); };
    $('#viewEarningsBtn').onclick = ()=>{ alert("Earnings page (demo)"); };

    // support
    $('#supportSendBtn').onclick = ()=>{ const msg = $('#supportUserMsg').value.trim(); if(!msg) return; $('#supportChatBox').innerHTML += `<div><b>You:</b> ${msg}</div>`; $('#supportUserMsg').value=''; setTimeout(()=>{ $('#supportChatBox').innerHTML += `<div class="small muted"><b>Bot:</b> Thanks — we'll get back to you (demo)</div>`; },800); };

    // swap coin population
    const coinList = await fetch(`${COINGECKO_BASE}/coins/list`).then(r=>r.json()).catch(()=>[]);
    const shortList = (coinList||[]).slice(0,120);
    $('#swapFromCoin').innerHTML = shortList.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    $('#swapToCoin').innerHTML = shortList.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');

    // page switch bindings (some direct buttons)
    document.querySelectorAll('[data-target]').forEach(el=>el.addEventListener('click', e=>{ e.preventDefault(); const t = el.dataset.target; if(t) switchPage(t); }));
    // footer tabs wired above; also provide landing actions
    $('#connectWalletBtn').addEventListener('click', ()=>{ $('#walletModal').classList.remove('hide'); });

    // theme toggle
    $('#themeSelect') && ($('#themeSelect').onchange = function(){ if(this.value==='light'){ document.body.style.background='#fff'; document.body.style.color='#000'; } else { document.body.style.background='var(--bg)'; document.body.style.color='#fff'; } });

    // install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; $('#installPrompt').classList.remove('hide'); });
    $('#installNowBtn').onclick = async ()=>{
      if(deferredPrompt){ deferredPrompt.prompt(); const choice = await deferredPrompt.userChoice; $('#installPrompt').classList.add('hide'); }
      else if(navigator.share){ navigator.share({title:'Auto Trading Bot', url:location.href}); }
      else alert("Use your browser menu to install.");
    };
    $('#maybeLaterBtn').onclick = ()=>{ $('#installPrompt').classList.add('hide'); };

    // close account
    $('#closeAccountBtn').onclick = async ()=>{
      if(!confirm("Close account? This is demo — will clear local data.")) return;
      localStorage.clear(); location.reload();
    };

    // disconnect only button (as requested)
    $('#disconnectBtn').onclick = ()=>{ disconnectWallet(); };

    // update UI initial
    updateUIOnConnect();
  });

  /* ---------- small helpers ---------- */
  function saveLS(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function getLS(k, fallback){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):fallback;}catch(e){return fallback;} }

  /* ---------- Inline service worker registration (register from inline code blob) ---------- */
  if('serviceWorker' in navigator){
    const swCode = `
      const CACHE_NAME = 'auto-trade-cache-v1';
      const ASSETS = ['./','/index.html','/app-logo.png'];
      self.addEventListener('install', event=>{ self.skipWaiting(); event.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(ASSETS)).catch(()=>{})); });
      self.addEventListener('activate', event=>{ event.waitUntil(self.clients.claim()); });
      self.addEventListener('fetch', event=>{ event.respondWith(caches.match(event.request).then(res=>res||fetch(event.request).catch(()=>caches.match('/')))); });
    `;
    const blob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).then(()=>{ console.log('SW registered from blob'); }).catch(e=>console.warn('SW register failed', e));
  }

  </script>
</body>
  </html>
