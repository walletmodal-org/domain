<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blockchain Auto-Trading Bot</title>
  <meta name="theme-color" content="#0b0f14"/>
  <!-- Manifest (you can replace with a separate manifest.json if desired) -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="app-logo.png">
  <link rel="apple-touch-icon" href="app-logo.png">
  <!-- Tailwind utilities (quick) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- TradingView (chart embed) -->
  <script src="https://s3.tradingview.com/tv.js"></script>

  <!-- Ethers + Web3Modal + WalletConnect + TronWeb -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@4.4.0/dist/TronWeb.js"></script>

  <!-- otplib + qrious for 2FA & QR (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/otplib@12.0.1/otplib.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1318; --muted:#8a8f98; --accent:#f0b90b; --card:#121316;
      --glass: rgba(255,255,255,0.02);
    }
    html,body{height:100%}
    body { background:var(--bg); color:#fff; font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; margin:0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .container{max-width:1100px;margin:0 auto;padding:0 12px}
    header, footer { background: #000000aa; backdrop-filter: blur(6px); }
    .btn { padding: .56rem .9rem; border-radius: 8px; font-weight:600; display:inline-flex; align-items:center; gap:.6rem; cursor:pointer; border:0; }
    .btn-primary { background:var(--accent); color:#111; box-shadow:0 6px 18px rgba(240,185,11,0.08); }
    .btn-secondary { background: #1f2328; color:#fff; border:1px solid rgba(255,255,255,0.03); }
    .card { background:var(--panel); border-radius:12px; border:1px solid rgba(255,255,255,0.03); padding:14px; }
    .tv-container { border-radius:10px; overflow:hidden; background:#090b0f; border:1px solid rgba(255,255,255,0.03); }
    .hide{display:none!important} .show{display:block!important}
    .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.65); z-index:60 }
    .modal-content{ background:#0e1114; padding:20px; border-radius:12px; width:96%; max-width:420px; box-shadow:0 10px 40px rgba(0,0,0,0.6); }
    .sheet{ position:fixed; left:0; right:0; bottom:0; background:linear-gradient(180deg,#0e1114,#0b0d10); border-top-left-radius:12px; border-top-right-radius:12px; padding:14px; z-index:70 }
    .input { background:#0b0d10; border:1px solid rgba(255,255,255,0.03); color:#fff; padding:.6rem .8rem; border-radius:8px; width:100% }
    .small { font-size:12px; color:var(--muted) }
    .label { display:flex; gap:.6rem; align-items:center }
    .badge { background:#101214; border-radius:999px; padding:.25rem .6rem; font-weight:600 }
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .grid-2{grid-template-columns:1fr} header .search-hide { display:none } .footer-nav { display:flex; gap:4px; } }
    .footer-nav button{ flex:1; padding:10px 6px; display:flex; flex-direction:column; align-items:center; gap:6px; background:transparent; border:0; color:#cfd3d8 }
    nav .tab-active { color:var(--accent); }
    .icon { width:20px;height:20px; display:inline-block; }
    .coin-img { width:28px;height:28px;border-radius:8px;background:#0b0d10;display:inline-flex;align-items:center;justify-content:center }
    .muted { color:var(--muted) }
    .right { text-align:right }
    .flex { display:flex; align-items:center }
    .gap-2{gap:8px}
    .mt-2{margin-top:8px}
    .mb-2{margin-bottom:8px}
    .toggle-segment { display:flex; gap:8px; background:#0d1014; padding:6px; border-radius:999px; }
    .toggle-segment button { border-radius:999px; padding:8px 12px; background:transparent; color:var(--muted); border:0; }
    .toggle-segment button.active { background: linear-gradient(90deg,#15181c,#0b0d10); color:var(--accent); border:1px solid rgba(240,185,11,0.12); }
    .text-muted-foreground { color:#9aa1a9; }
    .hidden { display:none!important; }
  </style>
</head>
<body>

  <!-- Notification toast -->
  <div id="notifPop" class="hide" style="position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:120;background:#0d1113;padding:10px 16px;border-radius:10px;border:1px solid rgba(240,185,11,0.18);color:var(--accent)"></div>

  <!-- Install prompt -->
  <div id="installPrompt" class="modal hide" aria-hidden="true">
    <div class="modal-content">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0">Install App</h3>
          <p class="small muted">Install the Auto-Trading Bot for a native-like experience.</p>
        </div>
        <img src="app-logo.png" alt="logo" style="width:44px;height:44px;border-radius:8px">
      </div>
      <div class="mt-2" style="display:flex;gap:10px;justify-content:flex-end">
        <button id="maybeLaterBtn" class="btn btn-secondary">Maybe later</button>
        <button id="installNowBtn" class="btn btn-primary">Install</button>
      </div>
    </div>
  </div>

  <!-- Wallet Modal -->
  <div id="walletModal" class="modal hide" aria-hidden="true">
    <div class="modal-content">
      <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:10px">
        <strong>Connect Wallet</strong>
        <button id="closeWalletModal" class="btn btn-secondary" title="Close">✕</button>
      </div>
      <div style="display:grid;gap:10px">
        <button id="connectMetaMask" class="btn btn-primary">MetaMask</button>
        <button id="connectWalletConnect" class="btn btn-secondary">WalletConnect</button>
        <button id="connectTron" class="btn btn-secondary">TronLink</button>
        <button id="manualAddressBtn" class="btn btn-secondary">Manual Address</button>

        <div id="manualAddressInput" class="hide">
          <input id="manualInput" class="input" placeholder="Paste wallet address" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="manualConfirm" class="btn btn-primary">Confirm</button>
            <button id="manualCancel" class="btn btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal hide">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Login with Account ID</strong>
        <button id="closeLoginModal" class="btn btn-secondary">✕</button>
      </div>
      <div class="mt-2">
        <input id="loginInput" class="input" maxlength="10" placeholder="10-digit account ID" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="loginConfirm" class="btn btn-primary">Login</button>
          <button id="loginCancel" class="btn btn-secondary">Cancel</button>
        </div>
        <div id="loginMsg" class="small muted mt-2"></div>
      </div>
    </div>
  </div>

  <!-- Account Modal -->
  <div id="accountModal" class="modal hide">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Account</strong>
        <button id="closeAccModal" class="btn btn-secondary">✕</button>
      </div>
      <div class="mt-2 small muted">
        <div>Address</div>
        <div id="accModalAddr" style="word-break:break-all;margin:6px 0"></div>
        <div>Wallet ID</div>
        <div id="accModalId" style="margin:6px 0"></div>
        <div>Balance</div>
        <div id="accModalBal" style="margin:6px 0"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="secureAccBtn" class="btn btn-secondary">Secure (2FA)</button>
        <button id="closeAccModalBtn" class="btn btn-primary">Close</button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="container flex items-center justify-between py-3">
    <div class="flex items-center gap-3">
      <img src="app-logo.png" alt="logo" style="width:44px;height:44px;border-radius:8px" />
      <div>
        <div style="font-weight:700">Blockchain Auto-Trading Bot</div>
        <div class="small muted">Lite / Pro</div>
      </div>
    </div>

    <div class="search-hide" style="flex:1;margin:0 14px;">
      <input id="globalSearch" class="input" placeholder="Search coins, pairs or features" />
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <button id="qrBtn" class="btn btn-secondary" title="QR Scanner">Scan</button>
      <button id="notifBtn" class="btn btn-secondary" title="Notifications">Alerts</button>
      <button id="settingsBtn" class="btn btn-secondary" title="Settings">Settings</button>

      <div style="position:relative">
        <button id="moreBtn" class="btn btn-secondary">More ▾</button>
        <div id="moreMenu" class="card hide" style="position:absolute;right:0;top:48px;width:220px">
          <a href="#" id="connectedWalletBtn" class="small muted block py-2 px-3">Connected Wallet</a>
          <a href="#" id="settingsMenuBtn" class="small muted block py-2 px-3">Settings</a>
          <a href="#" id="supportBtn" class="small muted block py-2 px-3">Support</a>
          <a href="#" id="disconnectBtn" class="small muted block py-2 px-3">Disconnect</a>
        </div>
      </div>
    </div>
  </header>

  <!-- SPA Main -->
  <main class="container" id="appMain" style="padding-bottom:120px;margin-top:18px">

    <!-- Landing -->
    <section id="landingPage" class="page">
      <div style="text-align:center;margin-top:18px">
        <img src="app-logo.png" style="width:84px;height:84px;border-radius:12px" alt="logo" />
        <h1 style="color:var(--accent);margin-top:8px">Auto-Trading Bot</h1>
        <p class="muted" style="max-width:760px;margin:6px auto">Automate trading with on-chain precision and AI-driven strategies. Connect wallet, configure risk controls, and run simulations.</p>

        <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
          <button id="connectWalletBtn" class="btn btn-primary">Connect Wallet</button>
          <button id="loginIdBtn" class="btn btn-secondary">Login ID</button>
          <button id="getMobileAppBtn" class="btn btn-primary">Get Mobile App</button>
        </div>

        <div style="max-width:760px;margin:16px auto">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="small muted">Wallet status</div>
                <div id="walletText">Wallet not connected</div>
              </div>
              <div class="right">
                <div class="small muted">Total Balance</div>
                <div id="totalBalance" style="font-weight:700">$0.00</div>
              </div>
            </div>
          </div>
        </div>

        <div style="max-width:1100px;margin:20px auto">
          <h3 style="margin-bottom:8px">Market Overview</h3>
          <div id="landingMarket" class="card" style="min-height:120px"></div>

          <h3 style="margin-top:18px">Top Coins</h3>
          <div id="landingTopCoins" class="grid-2 mt-2"></div>
        </div>
      </div>
    </section>

    <!-- Home -->
    <section id="home" class="page hide">
      <div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small muted">Wallet ID</div>
          <div id="walletId" style="font-weight:700">—</div>
        </div>
        <div class="right">
          <div class="small muted">Main Balance</div>
          <div id="mainBalance" style="font-weight:700">$0.00</div>
          <div class="small muted">Trade Balance</div>
          <div id="tradeBalance" style="font-weight:600">$0.00</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="depositBtn" class="btn btn-primary">Deposit</button>
        <button id="transferBtn" class="btn btn-secondary">Transfer</button>
        <button id="withdrawBtn" class="btn btn-primary">Withdraw</button>
      </div>

      <div style="margin-top:12px" class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:10px;align-items:center">
            <div class="coin-img" id="usdtLogoWrap"><img id="usdtLogo" src="" alt="usdt" style="width:24px;height:24px;border-radius:6px"/></div>
            <div>
              <div style="font-weight:700">Tether USD (USDT)</div>
              <div id="usdtPrice" class="small muted">$1.00</div>
            </div>
          </div>
          <div class="small muted">BTC / USDT</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h3>Live Market</h3>
        <div class="tv-container" id="tvchart" style="height:320px"></div>
      </div>

      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Top Coins</div>
            <button id="refreshMarkets" class="btn btn-secondary">Refresh</button>
          </div>
          <div id="topCoinsList" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Gainers & Losers</div>
            <div class="small muted">24h</div>
          </div>

          <div style="display:flex;justify-content:flex-start;margin-top:10px">
            <div class="toggle-segment" role="tablist" aria-label="Gainers or Losers">
              <button id="btnGainers" class="active">Gainers</button>
              <button id="btnLosers">Losers</button>
            </div>
          </div>

          <div style="margin-top:8px">
            <div id="gainersLosersList" class="small muted"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Markets -->
    <section id="markets" class="page hide">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Markets</h2>
        <div class="small muted">Spot</div>
      </div>
      <div class="card mt-2">
        <div style="display:flex;gap:8px">
          <input id="marketSearch" class="input" placeholder="Search (e.g., bitcoin, eth)" />
          <button id="marketRefresh" class="btn btn-secondary">Refresh</button>
        </div>
        <div id="marketsList" style="margin-top:12px;max-height:56vh;overflow:auto"></div>
      </div>
    </section>

    <!-- Swap -->
    <section id="SwapPage" class="page hide">
      <h2>Swap</h2>
      <div class="card">
        <div style="display:flex;gap:8px">
          <select id="swapFromCoin" class="input"></select>
          <button id="swapSwitchBtn" class="btn btn-secondary">⇅</button>
          <select id="swapToCoin" class="input"></select>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="swapAmount" class="input" placeholder="Amount" />
          <button id="swapBtnSwapPage" class="btn btn-primary">Swap</button>
        </div>
        <div id="swapRate" class="small muted mt-2"></div>
        <div id="swapResult" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- Trade -->
    <section id="trade" class="page hide">
      <h2>Trade</h2>

      <!-- MT5 / Trade summary -->
      <div id="mt5DashboardSection"></div>

      <div class="card mt-2">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Trade Account</div>
          <div class="small muted">Use Transfer on Home to add funds</div>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <select id="tradeSymbol" class="input" style="max-width:220px">
            <option value="BINANCE:BTCUSDT">BTC/USDT</option>
            <option value="BINANCE:ETHUSDT">ETH/USDT</option>
            <option value="BINANCE:BNBUSDT">BNB/USDT</option>
          </select>
          <button id="loadSymbol" class="btn btn-secondary">Load Chart</button>
        </div>

        <div id="tradeChart" class="tv-container" style="height:320px;margin-top:12px"></div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="placeTradeBtn" class="btn btn-primary">Place Trade (All funds)</button>
          <button id="viewEarningsBtn" class="btn btn-secondary">View Earnings</button>
        </div>

        <div id="tradeActiveTradesList" class="small muted mt-3">No active trades</div>

        <!-- Trade simulation controls -->
        <div class="mt-3">
          <div class="card">
            <div style="font-weight:700">Trading Simulation</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="investmentAmount" class="input" placeholder="Investment amount (USD)" />
              <select id="tradingDuration" class="input" style="max-width:160px">
                <option value="1">1 month</option>
                <option value="3">3 months</option>
                <option value="6">6 months</option>
              </select>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="calcReturnsBtn" class="btn btn-secondary">Calculate Returns</button>
              <button id="startSimBtn" class="btn btn-primary">Start Simulation</button>
              <button id="stopSimBtn" class="btn btn-secondary">Stop Simulation</button>
            </div>

            <div id="tradingResults" class="hidden mt-2">
              <div class="small muted">Initial: <span id="initialInvestment">-</span></div>
              <div class="small muted">Duration: <span id="investmentDuration">-</span></div>
              <div class="small muted">Days: <span id="totalDays">-</span></div>
              <div class="small muted">Final: <span id="finalAmount">-</span></div>
              <div class="small muted">Profit: <span id="totalProfit">-</span></div>
              <div class="small muted">ROI: <span id="roi">-</span></div>
            </div>

            <div id="activeTradingDisplay" class="hidden mt-2">
              <div class="small muted">Current Value: <span id="currentTradingValue">-</span></div>
              <div class="small muted">Current Profit: <span id="currentProfit">-</span></div>
              <div class="small muted">Days Remaining: <span id="daysRemaining">-</span></div>
            </div>
          </div>
        </div>

        <!-- Trade dynamic section (for placing specific orders) -->
        <div id="tradeMainSection" class="hidden"></div>
        <div id="tradeDynamicSection" class="hidden"></div>
      </div>
    </section>

    <!-- Futures -->
    <section id="futures" class="page hide">
      <h2>Futures</h2>
      <div class="tv-container" id="futuresChart" style="height:420px;margin-top:12px"></div>
      <div class="card mt-2">
        <div id="futuresList" class="small muted">No futures data.</div>
      </div>
    </section>

    <!-- Wallets -->
    <section id="wallets" class="page hide">
      <h2>Wallets</h2>
      <div class="card mt-2">
        <div style="display:flex;justify-content:space-between">
          <div>
            <div class="small muted">Wallet ID</div>
            <div id="walletId2" style="font-weight:700">—</div>
          </div>
          <div class="right">
            <div class="small muted">Main Balance</div>
            <div id="totalBalance2" style="font-weight:700">$0.00</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="font-weight-700">Holdings</div>
          <div id="walletHoldings" class="small muted mt-2">No holdings</div>
        </div>
      </div>
    </section>

    <!-- Settings -->
    <section id="settingsPage" class="page hide">
      <h2>Settings</h2>
      <div class="card mt-2">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>Enable Notifications</div>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="notifToggle" />
            <span class="small muted" id="notifToggleLabel">Off</span>
          </label>
        </div>

        <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
          <div>Theme</div>
          <select id="themeSelect" class="input" style="max-width:160px">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select>
        </div>

        <div style="margin-top:12px">
          <button id="closeAccountBtn" class="btn btn-primary">Close Account (clear data)</button>
        </div>
      </div>
    </section>

    <!-- Support -->
    <section id="supportPage" class="page hide">
      <h2>Support</h2>
      <div class="card mt-2">
        <div class="font-weight-700">FAQs</div>
        <div class="small muted mt-2">
          <div><b>How to connect?</b> Use Connect Wallet on landing or header.</div>
          <div class="mt-1"><b>How to add funds?</b> Use Transfer to move funds to trade account.</div>
        </div>
      </div>

      <div class="card mt-2">
        <div style="font-weight:700">Live Support AI Bot</div>
        <div id="supportChatBox" style="height:180px;overflow:auto;background:#0b0d10;padding:8px;border-radius:8px;margin-top:8px"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="supportUserMsg" class="input" placeholder="Type message..." />
          <button id="supportSendBtn" class="btn btn-primary">Send</button>
        </div>
      </div>
    </section>

    <!-- Notifications -->
    <section id="notifPage" class="page hide">
      <h2>Notifications</h2>
      <div id="notifList" class="card mt-2 small muted">No notifications yet.</div>
    </section>

  </main>

  <!-- Footer Nav -->
  <footer class="fixed bottom-0 left:0 right:0" style="background:#060708;padding:6px 0;box-shadow:0 -6px 24px rgba(0,0,0,0.6)">
    <nav class="container footer-nav" style="display:flex;gap:6px;align-items:center">
      <button class="tab tab-home tab-active" data-target="home" aria-label="Home">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 9.5L12 3l9 6.5V21a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z" stroke="#cfd3d8"/></svg>
        <span class="small muted">Home</span>
      </button>
      <button class="tab tab-markets" data-target="markets" aria-label="Markets">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 3v18h18" stroke="#cfd3d8"/></svg>
        <span class="small muted">Markets</span>
      </button>
      <button class="tab tab-trade" data-target="trade" aria-label="Trade">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 12h18M12 3v18" stroke="#cfd3d8"/></svg>
        <span class="small muted">Trade</span>
      </button>
      <button class="tab tab-futures" data-target="futures" aria-label="Futures">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 2v20" stroke="#cfd3d8"/></svg>
        <span class="small muted">Futures</span>
      </button>
      <button class="tab tab-wallets" data-target="wallets" aria-label="Wallets">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><rect x="2" y="6" width="20" height="12" rx="2" stroke="#cfd3d8"/></svg>
        <span class="small muted">Wallets</span>
      </button>
    </nav>
  </footer>

  <!-- Inline JS: All logic -->
  <script>
  /* ---------- Constants & LocalStorage keys ---------- */
  const LS = {
    user: "autoTrade_user",
    balances: "autoTrade_balances",
    trades: "autoTrade_trades",
    notif: "autoTrade_notif",
    coinCache: "autoTrade_coinCache",
    lastPage: "autoTrade_lastPage",
    tradingSimulation: "tradingSimulation"
  };

  const COINGECKO_BASE = 'https://api.coingecko.com/api/v3';
  // Trade constants
  const TRADE_RETURNS_RATE = 0.0008; // daily rate (for simulation)
  const TRADE_DURATIONS = [1,3,6];

  /* ---------- App state ---------- */
  let app = {
    provider: null,
    web3Provider: null,
    signer: null,
    address: null,
    chainId: null,
    mainBalance: 0,
    tradeBalance: 0,
    marketTop: [],
    coinCache: [],
    isConnected: false
  };

  // Trading simulation runtime
  let tradingSimulationData = null;
  let tradingSimulationInterval = null;
  let usdtAmount = 0; // derived from trade state

  /* ---------- Tiny DOM helpers ---------- */
  function $(sel){ return document.querySelector(sel); }
  function $all(sel){ return Array.from(document.querySelectorAll(sel)); }
  function fmtUsd(n){ return typeof n==="number" ? n.toLocaleString('en-US',{style:'currency',currency:'USD'}) : n; }
  function notify(msg, timeout=3000){ const el = $('#notifPop'); if(!el) return; el.textContent = msg; el.classList.remove('hide'); setTimeout(()=>el.classList.add('hide'), timeout); }
  function saveLS(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  function getLS(key, fallback=null){ try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }catch(e){ return fallback; } }
  function delLS(key){ localStorage.removeItem(key); }

  /* ---------- SPA navigation ---------- */
  function switchPage(pageId, skipPersist=false){
    $all('.page').forEach(p=>p.classList.add('hide'));
    const target = document.getElementById(pageId);
    if(target) target.classList.remove('hide');
    if(!skipPersist) saveLS(LS.lastPage, pageId);
    // page-specific
    if(pageId === 'home') { loadUsdt(); loadMarkets(); showGainers(); }
    if(pageId === 'markets') loadMarkets();
    if(pageId === 'landingPage') loadLanding();
    if(pageId === 'trade') renderTradeMainSection();
    window.scrollTo(0,0);
  }
  // footer/tab wiring
  $all('.tab').forEach(t=>t.addEventListener('click',()=>{ const tgt=t.dataset.target; if(tgt) switchPage(tgt); $all('.tab').forEach(x=>x.classList.remove('tab-active')); t.classList.add('tab-active'); }));

  /* ---------- Wallet: Web3Modal + Ethers ---------- */
  let web3Modal;
  let providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider?.default || window.WalletConnectProvider,
      options: {
        rpc: { 1: "https://cloudflare-eth.com", 56: "https://bsc-dataseed.binance.org/", 137: "https://rpc-mainnet.maticvigil.com/" }
      }
    }
  };
  function initWeb3Modal(){ web3Modal = new window.Web3Modal.default({ cacheProvider: true, providerOptions }); }

  async function connectWallet(){
    try{
      const provider = await web3Modal.connect();
      app.provider = provider;
      app.web3Provider = new ethers.providers.Web3Provider(provider);
      app.signer = app.web3Provider.getSigner();
      const addr = await app.signer.getAddress();
      app.address = addr;
      app.chainId = (await app.web3Provider.getNetwork()).chainId;
      app.isConnected = true;
      saveLS(LS.user, { address: app.address, chainId: app.chainId });
      // provider events
      provider.on && provider.on("accountsChanged", (accounts)=>{ if(accounts && accounts.length) { app.address = accounts[0]; saveLS(LS.user,{address:app.address,chainId:app.chainId}); updateUIOnConnect(); } else disconnectWallet(); });
      provider.on && provider.on("chainChanged", (chainId)=>{ app.chainId = parseInt(chainId, 16); saveLS(LS.user,{address:app.address,chainId:app.chainId}); updateUIOnConnect(); });
      provider.on && provider.on("disconnect", ()=>{ disconnectWallet(); });
      updateUIOnConnect();
      notify("Wallet connected");
      return true;
    }catch(err){
      console.warn("connectWallet error", err);
      notify("Wallet connection failed");
      return false;
    }
  }

  function disconnectWallet(){
    if(web3Modal) web3Modal.clearCachedProvider && web3Modal.clearCachedProvider();
    if(app.provider && app.provider.disconnect) try{ app.provider.disconnect(); }catch(e){}
    app.provider = null; app.web3Provider = null; app.signer = null; app.address = null; app.chainId = null; app.isConnected=false;
    delLS(LS.user);
    notify("Disconnected");
    updateUIOnConnect();
    switchPage('landingPage');
  }

  function shortAddr(a){ if(!a) return ""; if(a.startsWith("0x")) return a.slice(0,6)+"..."+a.slice(-4); return a.slice(0,6)+"..."+a.slice(-4); }

  /* ---------- Balances & persistence ---------- */
  function initBalances(){
    const st = getLS(LS.balances, null) || { mainBalance: 0, tradeBalance: 0 };
    app.mainBalance = st.mainBalance || 0;
    app.tradeBalance = st.tradeBalance || 0;
    usdtAmount = getTradeState().totalBalance || app.tradeBalance;
  }
  function saveBalances(){
    saveLS(LS.balances, { mainBalance: app.mainBalance, tradeBalance: app.tradeBalance });
  }
  function updateUIOnConnect(){
    if(app.address){
      $('#walletText').textContent = "Connected: " + shortAddr(app.address);
      $('#walletId').textContent = shortAddr(app.address);
      $('#walletId2').textContent = shortAddr(app.address);
      $('#accModalAddr').textContent = app.address;
      $('#accModalId').textContent = app.address;
      $('#disconnectBtn').classList.remove('hide');
      $('#connectWalletBtn').textContent = "Wallet connected";
    } else {
      $('#walletText').textContent = "Wallet not connected";
      $('#walletId').textContent = "—";
      $('#walletId2').textContent = "—";
      $('#accModalAddr').textContent = "";
      $('#accModalId').textContent = "";
      $('#disconnectBtn').classList.add('hide');
      $('#connectWalletBtn').textContent = "Connect Wallet";
    }
    $('#mainBalance').textContent = fmtUsd(app.mainBalance);
    $('#tradeBalance').textContent = fmtUsd(app.tradeBalance);
    $('#totalBalance').textContent = fmtUsd(app.mainBalance + app.tradeBalance);
    $('#totalBalance2').textContent = fmtUsd(app.mainBalance + app.tradeBalance);
    $('#accModalBal').textContent = fmtUsd(app.mainBalance + app.tradeBalance);
  }

  /* ---------- CoinGecko fetches: markets, top coins, gainers/losers ---------- */
  async function loadUsdt(){
    try{
      const res = await fetch(`${COINGECKO_BASE}/coins/tether`);
      const data = await res.json();
      if(data?.image?.thumb) $('#usdtLogo').src = data.image.thumb;
      const markets = await fetch(`${COINGECKO_BASE}/coins/markets?vs_currency=usd&ids=tether`).then(r=>r.json());
      if(markets && markets[0] && $('#usdtPrice')) $('#usdtPrice').textContent = fmtUsd(markets[0].current_price);
    }catch(e){ console.warn("USDT load failed", e); }
  }

  async function loadMarkets(){
    try{
      const url = `${COINGECKO_BASE}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=80&page=1&sparkline=false&price_change_percentage=24h`;
      const data = await fetch(url).then(r=>r.json());
      app.marketTop = data;
      if($('#topCoinsList')) $('#topCoinsList').innerHTML = data.slice(0,8).map(c=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.02)"><div style="display:flex;gap:8px;align-items:center"><img src="${c.image}" style="width:28px;height:28px;border-radius:6px"/><div><div style="font-weight:600">${c.name}</div><div class="small muted">${c.symbol.toUpperCase()}</div></div></div><div class="right">${fmtUsd(c.current_price)}<div class="small muted">${(c.price_change_percentage_24h||0).toFixed(2)}%</div></div></div>`).join('');
      // landing top
      if($('#landingTopCoins')) {
        const el = $('#landingTopCoins'); el.innerHTML = "";
        data.slice(0,8).forEach(c=>{
          const div = document.createElement('div');
          div.className = 'card';
          div.style.display = 'flex'; div.style.justifyContent = 'space-between'; div.style.alignItems='center';
          div.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><img src="${c.image}" style="width:36px;height:36px;border-radius:8px"/><div><div style="font-weight:700">${c.name}</div><div class="small muted">${c.symbol.toUpperCase()}</div></div></div><div class="right">${fmtUsd(c.current_price)}<div class="small muted">${(c.price_change_percentage_24h||0).toFixed(2)}%</div></div>`;
          el.appendChild(div);
        });
      }
    }catch(e){ console.warn("loadMarkets error", e); }
  }

  async function showGainers(){
    try{
      const data = app.marketTop.length ? app.marketTop : await fetch(`${COINGECKO_BASE}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=80&page=1&sparkline=false&price_change_percentage=24h`).then(r=>r.json());
      // sort by 24h change desc
      const sorted = data.slice().sort((a,b)=>(b.price_change_percentage_24h||0)-(a.price_change_percentage_24h||0));
      renderGainersLosers(sorted.slice(0,10), 'Gainers');
    }catch(e){ console.warn('showGainers', e); }
  }

  async function showLosers(){
    try{
      const data = app.marketTop.length ? app.marketTop : await fetch(`${COINGECKO_BASE}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=80&page=1&sparkline=false&price_change_percentage=24h`).then(r=>r.json());
      const sorted = data.slice().sort((a,b)=>(a.price_change_percentage_24h||0)-(b.price_change_percentage_24h||0));
      renderGainersLosers(sorted.slice(0,10), 'Losers');
    }catch(e){ console.warn('showLosers', e); }
  }

  function renderGainersLosers(list, title){
    const el = $('#gainersLosersList');
    if(!el) return;
    el.innerHTML = list.map(c=>{
      const sign = (c.price_change_percentage_24h||0) >= 0 ? '+' : '';
      return `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.02)"><div style="display:flex;gap:10px;align-items:center"><img src="${c.image}" style="width:28px;height:28px;border-radius:6px"/><div><div style="font-weight:600">${c.symbol.toUpperCase()} — ${c.name}</div><div class="small muted">${c.market_cap_rank?('Rank '+c.market_cap_rank):''}</div></div></div><div class="right">${fmtUsd(c.current_price)}<div class="${(c.price_change_percentage_24h||0)>=0 ? 'small' : 'small'}">${sign}${(c.price_change_percentage_24h||0).toFixed(2)}%</div></div></div>`;
    }).join('');
  }

  async function loadLanding(){ await loadMarkets(); if(app.marketTop && $('#landingMarket')){ const top = app.marketTop.slice(0,5); $('#landingMarket').innerHTML = `<div style="display:flex;gap:12px;align-items:center">${top.map(c=>`<div style="display:flex;flex-direction:column;align-items:center"><img src="${c.image}" style="width:36px;height:36px;border-radius:8px"/><div class="small muted">${c.symbol.toUpperCase()}</div><div>${fmtUsd(c.current_price)}</div></div>`).join('')}</div>`; } }

  /* ---------- TradingView init & embed (from your code) ---------- */
  function initializeTradingView() {
    if (typeof TradingView === 'undefined') return;
    const container = document.getElementById('tvchart');
    if (!container) return;
    try {
      new TradingView.widget({
        width: '100%',
        height: 400,
        symbol: "BINANCE:BTCUSDT",
        interval: "1D",
        timezone: "Etc/UTC",
        theme: "dark",
        style: "1",
        locale: "en",
        toolbar_bg: "#1a1d29",
        enable_publishing: false,
        allow_symbol_change: true,
        container_id: "tvchart",
        hide_side_toolbar: false,
      });
    } catch (error) {
      console.error('TradingView init failed:', error);
      container.innerHTML = '<div class="flex items-center justify-center h-full text-muted-foreground">Chart loading...</div>';
    }
  }

  function embedTradeChart(symbol, containerId = "tradeChart") {
    if (typeof TradingView === 'undefined') return;
    let el = document.getElementById(containerId);
    if (!el) return;
    el.innerHTML = '';
    let tvWidget = document.createElement('div');
    tvWidget.id = `tvChartEmbed_${containerId}`;
    tvWidget.style = "height:340px;";
    el.appendChild(tvWidget);
    try {
      new TradingView.widget({
        container_id: tvWidget.id,
        autosize: true,
        symbol: symbol,
        interval: "D",
        timezone: "Etc/UTC",
        theme: "dark",
        style: "1",
        locale: "en",
        toolbar_bg: "#0b0f14",
        enable_publishing: false,
        allow_symbol_change: true,
        studies: [],
        details: true,
        withdateranges: true,
        hide_side_toolbar: false
      });
    } catch (e) { console.warn('embedTradeChart failed', e); }
  }

  /* ---------- Trade state helpers ---------- */
  function now(){ return Math.floor(Date.now()/1000); }
  function formatCountdown(seconds){
    if(seconds <= 0) return "0d";
    const d = Math.floor(seconds/86400); seconds %= 86400;
    const h = Math.floor(seconds/3600); seconds %= 3600;
    const m = Math.floor(seconds/60);
    return `${d}d ${h}h ${m}m`;
  }

  function getTradeState(){
    const st = getLS('trade_state', null) || { totalBalance: 0, totalEarnings: 0, totalReturns: 0, trades: [], lastSymbol: null };
    // ensure fields
    st.totalBalance = st.totalBalance || 0;
    st.totalEarnings = st.totalEarnings || 0;
    st.totalReturns = st.totalReturns || 0;
    st.trades = st.trades || [];
    return st;
  }
  function setTradeState(state){ saveLS('trade_state', state); }
  function delTradeState(){ delLS('trade_state'); }

  /* ---------- Trading simulation & functions (as provided) ---------- */
  function calculateTradingReturns() {
    const amountEl = document.getElementById('investmentAmount');
    const durEl = document.getElementById('tradingDuration');
    if (!amountEl || !durEl) return alert('UI missing inputs for calculation');
    const amount = parseFloat(amountEl.value);
    const duration = parseInt(durEl.value);
    if (!amount || amount <= 0) { alert('Please enter a valid investment amount'); return; }
    if (!duration || duration <= 0) { alert('Please select a valid duration'); return; }
    const state = getTradeState();
    if (amount > state.totalBalance) { alert('Investment amount cannot exceed available balance'); return; }
    const dailyRate = TRADE_RETURNS_RATE;
    const totalDays = duration * 30;
    const finalAmount = amount * Math.pow(1 + dailyRate, totalDays);
    const totalProfit = finalAmount - amount;
    const roi = (totalProfit / amount) * 100;
    tradingSimulationData = { initialAmount: amount, duration, totalDays, finalAmount, totalProfit, roi, dailyRate };
    if ($('#initialInvestment')) $('#initialInvestment').textContent = `$${amount.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
    if ($('#investmentDuration')) $('#investmentDuration').textContent = `${duration} month${duration>1?'s':''}`;
    if ($('#totalDays')) $('#totalDays').textContent = `${totalDays} days`;
    if ($('#finalAmount')) $('#finalAmount').textContent = `$${finalAmount.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
    if ($('#totalProfit')) $('#totalProfit').textContent = `$${totalProfit.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
    if ($('#roi')) $('#roi').textContent = `${roi.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}%`;
    if ($('#tradingResults')) $('#tradingResults').classList.remove('hidden');
    notify("Returns calculated");
  }

  function transferToTradingSimulationAccount() {
    if (!tradingSimulationData) { alert('Please calculate returns first'); return; }
    let state = getTradeState();
    if (tradingSimulationData.initialAmount > state.totalBalance) { alert('Insufficient balance'); return; }
    state.totalBalance -= tradingSimulationData.initialAmount;
    setTradeState(state);
    updateBalanceDisplay();
    showTradingToast(`$${tradingSimulationData.initialAmount.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})} transferred to trading account`);
  }

  function startTradingSimulation() {
    if (!tradingSimulationData) { alert('Please calculate returns first'); return; }
    transferToTradingSimulationAccount();
    const startTime = Date.now();
    const endTime = startTime + (tradingSimulationData.totalDays * 24 * 60 * 60 * 1000);
    saveLS(LS.tradingSimulation, { ...tradingSimulationData, startTime, endTime, isActive: true });
    if ($('#tradingResults')) $('#tradingResults').classList.add('hidden');
    if ($('#activeTradingDisplay')) $('#activeTradingDisplay').classList.remove('hidden');
    updateTradingSimulation();
    tradingSimulationInterval = setInterval(updateTradingSimulation, 60000);
    showTradingToast('Trading simulation started successfully!');
  }

  function updateTradingSimulation() {
    const simulation = getLS(LS.tradingSimulation, {});
    if (!simulation.isActive) return;
    const nowMs = Date.now();
    const totalDuration = simulation.endTime - simulation.startTime;
    const elapsed = nowMs - simulation.startTime;
    const progress = Math.min(elapsed / totalDuration, 1);
    const currentValue = simulation.initialAmount * Math.pow(1 + simulation.dailyRate, simulation.totalDays * progress);
    const currentProfit = currentValue - simulation.initialAmount;
    const remainingDays = Math.max(0, Math.ceil((simulation.endTime - nowMs) / (24 * 60 * 60 * 1000)));
    if ($('#currentTradingValue')) $('#currentTradingValue').textContent = `$${currentValue.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
    if ($('#currentProfit')) $('#currentProfit').textContent = `$${currentProfit.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
    if ($('#daysRemaining')) $('#daysRemaining').textContent = `${remainingDays} days`;
    if (progress >= 1) completeTradingSimulation();
  }

  function completeTradingSimulation() {
    const simulation = getLS(LS.tradingSimulation, {});
    usdtAmount += (simulation.finalAmount || 0);
    let state = getTradeState(); state.totalBalance = usdtAmount; setTradeState(state);
    updateBalanceDisplay();
    delLS(LS.tradingSimulation);
    clearInterval(tradingSimulationInterval);
    if ($('#activeTradingDisplay')) $('#activeTradingDisplay').classList.add('hidden');
    showTradingToast(`Simulation complete! Final amount: $${(simulation.finalAmount||0).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`);
  }

  function stopTradingSimulation() {
    const simulation = getLS(LS.tradingSimulation, {});
    if (simulation.isActive) {
      const nowMs = Date.now();
      const totalDuration = simulation.endTime - simulation.startTime;
      const elapsed = nowMs - simulation.startTime;
      const progress = Math.min(elapsed / totalDuration, 1);
      const currentValue = simulation.initialAmount * Math.pow(1 + simulation.dailyRate, simulation.totalDays * progress);
      usdtAmount += currentValue;
      let state = getTradeState(); state.totalBalance = usdtAmount; setTradeState(state);
      updateBalanceDisplay();
      showTradingToast(`Simulation stopped. Returned: $${currentValue.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`);
    }
    delLS(LS.tradingSimulation);
    clearInterval(tradingSimulationInterval);
    if ($('#activeTradingDisplay')) $('#activeTradingDisplay').classList.add('hidden');
  }

  function showTradingToast(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-yellow-400 text-black px-4 py-2 rounded-lg shadow-lg z-[2000] transition-all duration-300';
    toast.textContent = message;
    toast.style.transform = 'translateX(400px)';
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.transform = 'translateX(0)'; }, 10);
    setTimeout(() => { toast.style.transform = 'translateX(400px)'; setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300); }, 3000);
  }

  /* ---------- Trade order flow functions (from provided code) ---------- */
  function renderMT5Dashboard() {
    let state = getTradeState();
    let totalInvested = state.trades.reduce((a,t) => t.active ? a + (t.amount||0) : a, 0);
    let balance = (state.totalBalance || 0) + (state.totalEarnings || 0);
    let equity = balance + (state.totalReturns || 0);
    let freeMargin = balance - totalInvested;
    if ($('#mt5DashboardSection')) {
      $('#mt5DashboardSection').innerHTML = `
        <div class="card" style="margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;margin-bottom:6px"><div style="font-weight:700">Balance</div><div style="font-family:monospace">${fmtUsd(balance)}</div></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:6px"><div style="font-weight:700">Equity</div><div style="font-family:monospace">${fmtUsd(equity)}</div></div>
          <div style="display:flex;justify-content:space-between"><div style="font-weight:700">Free Margin</div><div style="font-family:monospace">${fmtUsd(freeMargin)}</div></div>
        </div>`;
    }
  }

  function updateBalanceDisplay() {
    let state = getTradeState();
    if ($('#tradeTotalBalance')) $('#tradeTotalBalance').textContent = fmtUsd(state.totalBalance);
    if ($('#tradeTotalEarnings')) $('#tradeTotalEarnings').textContent = fmtUsd(state.totalEarnings);
    if ($('#tradeTotalReturns')) $('#tradeTotalReturns').textContent = fmtUsd(state.totalReturns);
    renderMT5Dashboard();
    const mainPortfolio = getMainPortfolio();
    if (document.getElementById('mainPortfolioBalance')) document.getElementById('mainPortfolioBalance').textContent = fmtUsd(mainPortfolio.totalPortfolio);
  }

  function renderTradeMainSection() {
    let state = getTradeState();
    usdtAmount = state.totalBalance;
    updateBalanceDisplay();
    renderActiveTrades();
    if (state.lastSymbol) {
      const el = document.getElementById('tradeChart');
      if (el) embedTradeChart(state.lastSymbol, 'tradeChart');
    }
    document.getElementById('tradeMainSection') && (document.getElementById('tradeMainSection').style.display = '');
    document.getElementById('tradeDynamicSection') && (document.getElementById('tradeDynamicSection').style.display = 'none');
    renderMT5Dashboard();
  }

  function renderActiveTrades() {
    let state = getTradeState();
    let nowTs = now();
    let html = state.trades.length ?
      state.trades.map(t => {
        let left = Math.max(0, t.end - nowTs);
        return `<div class="card" style="margin-bottom:8px;padding:10px">
          <div><b>${t.symbol}</b></div>
          <div>Duration: ${t.duration} month(s) (${formatCountdown(left)})</div>
          <div>Status: ${left>0 ? "Active" : "Completed"}</div>
          <div>Returns: ${fmtUsd(t.returns || 0)}</div>
          <div>Earnings: ${fmtUsd(t.earnings || 0)}</div>
        </div>`;
      }).join('') : '<div class="small muted">No active trades</div>';
    if ($('#tradeActiveTradesList')) $('#tradeActiveTradesList').innerHTML = html;
  }

  function setupTradeButtons() {
    if ($('#loadSymbol')) $('#loadSymbol').onclick = function() {
      let symbol = document.getElementById('tradeSymbol').value;
      let state = getTradeState(); state.lastSymbol = symbol; setTradeState(state);
      embedTradeChart(symbol, 'tradeChart');
    };
    if ($('#placeTradeBtn')) $('#placeTradeBtn').onclick = function() {
      let state = getTradeState();
      if (state.totalBalance < 100) return alert("You need at least $100 in your trade balance to place a trade.");
      renderPlaceTradeAssetPage();
    };
    if ($('#viewEarningsBtn')) $('#viewEarningsBtn').onclick = function() { renderEarningsPage(); };
    // Simulation buttons
    if ($('#calcReturnsBtn')) $('#calcReturnsBtn').onclick = calculateTradingReturns;
    if ($('#startSimBtn')) $('#startSimBtn').onclick = startTradingSimulation;
    if ($('#stopSimBtn')) $('#stopSimBtn').onclick = stopTradingSimulation;
  }

  function renderPlaceTradeAssetPage() {
    const dyn = document.getElementById('tradeDynamicSection');
    if (!dyn) return;
    document.getElementById('tradeMainSection') && (document.getElementById('tradeMainSection').style.display = 'none');
    dyn.style.display = '';
    dyn.innerHTML = `
      <div class="card">
        <div style="margin-bottom:8px;">
          <label class="small muted">Select Asset to Trade:</label>
          <div style="display:flex;gap:8px;margin-top:8px">
            <select id="tradeAssetSelect" class="input">
              <option value="BINANCE:BTCUSDT">BTC/USDT</option>
              <option value="BINANCE:ETHUSDT">ETH/USDT</option>
              <option value="BINANCE:BNBUSDT">BNB/USDT</option>
            </select>
            <button id="tradeAssetLoadBtn" class="btn btn-secondary">Load Asset Chart</button>
          </div>
        </div>
        <div id="tradeAssetChart" style="height:340px;" class="mt-2"></div>
        <div id="tradeDurationSection" class="mt-2"></div>
      </div>
    `;
    const btn = document.getElementById('tradeAssetLoadBtn');
    if (btn) btn.onclick = function() {
      let symbol = document.getElementById('tradeAssetSelect').value;
      embedTradeChart(symbol, "tradeAssetChart");
      setTimeout(() => renderTradeDurationSelect(symbol), 1000);
    };
  }

  function renderTradeDurationSelect(symbol) {
    const container = document.getElementById('tradeDurationSection');
    if (!container) return;
    container.innerHTML = `
      <div>
        <label class="small muted">Select Trade Duration:</label>
        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="tradingDurationSelect" class="input">
            ${TRADE_DURATIONS.map(d=>`<option value="${d}">${d} month${d>1?'s':''}</option>`).join('')}
          </select>
          <button id="tradeDurationBtn" class="btn btn-secondary">Confirm Duration</button>
        </div>
      </div>
    `;
    const btn = document.getElementById('tradeDurationBtn');
    if (btn) btn.onclick = function() {
      let duration = parseInt(document.getElementById('tradingDurationSelect').value);
      setTimeout(() => renderTradeOrderPage(symbol, duration), 300);
    };
  }

  function renderTradeOrderPage(symbol, duration) {
    const dyn = document.getElementById('tradeDynamicSection');
    if (!dyn) return;
    dyn.innerHTML = `
      <div class="card">
        <div>Asset: <b>${symbol}</b></div>
        <div>Duration: <b>${duration} month${duration>1?'s':''}</b></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="tradeOrderBtn" class="btn btn-primary">Place Order (Use All Trade Balance)</button>
          <button id="cancelOrderBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    `;
    const btn = document.getElementById('tradeOrderBtn');
    if (btn) btn.onclick = function() {
      activateTrade(symbol, duration);
      notify("Trade activated");
      renderTradeMainSection();
    };
    const cancel = document.getElementById('cancelOrderBtn');
    if (cancel) cancel.onclick = function(){ renderTradeMainSection(); };
  }

  function activateTrade(symbol, duration) {
    let state = getTradeState();
    let tradeStart = now();
    let tradeEnd = tradeStart + duration*2592000; // approx seconds in month
    let amount = state.totalBalance || 0;
    if (amount <= 0) { alert("No trade balance available"); return; }
    let returns = 0, earnings = 0;
    let trade = { symbol, duration, start: tradeStart, end: tradeEnd, amount, returns, earnings, active: true };
    state.trades.push(trade);
    state.totalBalance = 0; // all invested
    setTradeState(state);
    startTradeReturnsGenerator();
  }

  function startTradeReturnsGenerator() {
    let state = getTradeState();
    let nowTs = now();
    state.trades.forEach(trade => {
      if (trade.active && nowTs < trade.end) {
        let daysPassed = Math.floor((nowTs - trade.start)/86400);
        let returns = trade.amount * Math.pow(1 + TRADE_RETURNS_RATE, daysPassed) - trade.amount;
        trade.returns = returns;
        trade.earnings = trade.amount + returns;
        if (nowTs >= trade.end) trade.active = false;
      }
    });
    state.totalReturns = state.trades.reduce((a,t)=>a+(t.returns||0),0);
    state.totalEarnings = state.trades.reduce((a,t)=>a+(t.earnings||0),0);
    setTradeState(state);
    updateBalanceDisplay();
  }
  setInterval(startTradeReturnsGenerator, 60000);

  function initializeTradingSimulation() {
    const simulation = getLS(LS.tradingSimulation, {});
    if (simulation.isActive) {
      const activeDisplay = document.getElementById('activeTradingDisplay');
      if (activeDisplay) activeDisplay.classList.remove('hidden');
      updateTradingSimulation();
      tradingSimulationInterval = setInterval(updateTradingSimulation, 60000);
    }
  }

  /* ---------- Helper: simple portfolio calc ---------- */
  function getMainPortfolio(){
    // quick compute from trades + balances
    let state = getTradeState();
    let totalPortfolio = (state.totalBalance||0) + (state.totalEarnings||0);
    return { totalPortfolio };
  }

  /* ---------- UI wiring & events ---------- */
  document.addEventListener('DOMContentLoaded', async ()=>{
    // web3modal
    initWeb3Modal();
    // restore balances & trade state
    initBalances();
    const tstate = getTradeState();
    usdtAmount = tstate.totalBalance || 0;
    // try to auto connect via stored user
    const cachedUser = getLS(LS.user, null);
    if(web3Modal?.cachedProvider) {
      try{ await connectWallet(); }catch(e){}
    } else if(cachedUser && cachedUser.address){
      app.address = cachedUser.address;
      app.chainId = cachedUser.chainId||null;
      app.isConnected = true;
    }
    updateUIOnConnect();
    // load markets & chart
    await loadMarkets();
    await loadUsdt();
    initializeTradingView();
    setupTradeButtons();
    renderMT5Dashboard();
    renderActiveTrades();
    initializeTradingSimulation();

    // restore last page or go landing
    const last = getLS(LS.lastPage) || 'landingPage';
    switchPage(last, true);

    // Header wiring
    $('#connectWalletBtn').onclick = ()=>{ $('#walletModal').classList.remove('hide'); };
    $('#closeWalletModal').onclick = ()=>{ $('#walletModal').classList.add('hide'); };
    $('#connectMetaMask').onclick = async ()=>{ await connectWallet(); $('#walletModal').classList.add('hide'); };
    $('#connectWalletConnect').onclick = async ()=>{ await connectWallet(); $('#walletModal').classList.add('hide'); };
    $('#connectTron').onclick = async ()=>{ alert('Tron connect flow (TronLink)'); };
    $('#manualAddressBtn').onclick = ()=>{ $('#manualAddressInput').classList.remove('hide'); };
    $('#manualConfirm').onclick = ()=>{ const v = $('#manualInput').value.trim(); if(v.length>6){ app.address=v; app.isConnected=true; saveLS(LS.user,{address:v}); updateUIOnConnect(); $('#walletModal').classList.add('hide'); notify("Manual address saved"); } else alert("Enter valid address"); };
    $('#manualCancel').onclick = ()=>{ $('#manualAddressInput').classList.add('hide'); };

    $('#loginIdBtn').onclick = ()=>{ $('#loginModal').classList.remove('hide'); };
    $('#closeLoginModal').onclick = ()=>{ $('#loginModal').classList.add('hide'); };
    $('#loginCancel').onclick = ()=>{ $('#loginModal').classList.add('hide'); };
    $('#loginConfirm').onclick = async ()=>{
      const v = $('#loginInput').value.trim();
      if(!/^\d{10}$/.test(v)){ $('#loginMsg').textContent = "Enter a valid 10-digit ID"; return; }
      $('#loginMsg').textContent = "Logging in...";
      await new Promise(r=>setTimeout(r,900));
      $('#loginMsg').textContent = "Logged in";
      $('#loginModal').classList.add('hide'); notify("Logged in");
    };

    // more menu
    $('#moreBtn').onclick = ()=>{ $('#moreMenu').classList.toggle('hide'); };
    document.addEventListener('click', (ev)=>{ if(!ev.target.closest('#moreBtn') && !ev.target.closest('#moreMenu')) $('#moreMenu').classList.add('hide'); });
    $('#connectedWalletBtn').onclick = (e)=>{ e.preventDefault(); $('#walletModal').classList.remove('hide'); };
    $('#disconnectBtn').onclick = async ()=>{ disconnectWallet(); };

    // Home actions
    $('#depositBtn').onclick = async ()=> {
      const amt = prompt("Deposit amount (USD):", "100");
      if(!amt) return; const a = parseFloat(amt);
      if(isNaN(a)||a<=0) return alert("Invalid amount");
      app.mainBalance += a; saveBalances(); updateUIOnConnect(); notify("Deposited " + fmtUsd(a));
    };
    $('#transferBtn').onclick = async ()=>{
      let amt = prompt("Amount to transfer to Trade account (USD):", "100");
      if(!amt) return; amt = parseFloat(amt);
      if(isNaN(amt) || amt<=0) return alert("Invalid amount");
      if(amt > app.mainBalance) return alert("Insufficient main balance");
      app.mainBalance -= amt; app.tradeBalance += amt; saveBalances();
      // also sync with trade_state
      let ts = getTradeState(); ts.totalBalance = (ts.totalBalance || 0) + amt; setTradeState(ts);
      updateUIOnConnect(); updateBalanceDisplay();
      notify(`Transferred ${fmtUsd(amt)} to trade account`);
    };
    $('#withdrawBtn').onclick = ()=>{ const amt = prompt("Withdraw amount (USD):", "50"); if(!amt) return; const a = parseFloat(amt); if(isNaN(a)||a<=0) return alert("Invalid"); if(a>app.mainBalance+app.tradeBalance) return alert("Insufficient funds"); // prefer withdrawing from main first
      if(a<=app.mainBalance) app.mainBalance -= a; else { let rem = a - app.mainBalance; app.mainBalance = 0; app.tradeBalance = Math.max(0, app.tradeBalance - rem); let st = getTradeState(); st.totalBalance = app.tradeBalance; setTradeState(st);}
      saveBalances(); updateUIOnConnect(); updateBalanceDisplay(); notify("Withdrawn " + fmtUsd(a));
    };

    $('#refreshMarkets').onclick = ()=>{ loadMarkets(); notify("Markets refreshed"); };

    // Swap
    $('#swapBtnSwapPage').onclick = async ()=>{
      const from = $('#swapFromCoin').value; const to = $('#swapToCoin').value; const amt = parseFloat($('#swapAmount').value);
      if(!amt || amt<=0) return alert("Enter amount");
      const markets = await fetch(`${COINGECKO_BASE}/simple/price?ids=${from},${to}&vs_currencies=usd`).then(r=>r.json());
      const fromUsd = markets[from]?.usd || 0; const toUsd = markets[to]?.usd || 0;
      if(!fromUsd || !toUsd) return alert("Rate unavailable");
      const received = (amt * fromUsd) / toUsd;
      $('#swapResult').textContent = `Estimated receive: ${received.toFixed(6)} ${to.toUpperCase()}`;
      notify("Swap estimated");
    };

    // Trade buttons
    $('#loadSymbol').onclick = ()=>{ embedTradeChart($('#tradeSymbol').value, 'tradeChart'); let s = getTradeState(); s.lastSymbol = $('#tradeSymbol').value; setTradeState(s); };
    $('#placeTradeBtn').onclick = ()=>{ if(confirm("Place trade using all trade funds?")) { renderPlaceTradeAssetPage(); } };
    $('#viewEarningsBtn').onclick = ()=>{ renderEarningsPage(); };

    // Support
    $('#supportSendBtn').onclick = ()=>{ const msg = $('#supportUserMsg').value.trim(); if(!msg) return; $('#supportChatBox').innerHTML += `<div><b>You:</b> ${msg}</div>`; $('#supportUserMsg').value=''; setTimeout(()=>{ $('#supportChatBox').innerHTML += `<div class="small muted"><b>Bot:</b> Thanks — we'll get back to you</div>`; },800); };

    // populate swap coin list
    const coinList = await fetch(`${COINGECKO_BASE}/coins/list`).then(r=>r.json()).catch(()=>[]);
    const shortList = (coinList||[]).slice(0,120);
    if($('#swapFromCoin')) $('#swapFromCoin').innerHTML = shortList.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    if($('#swapToCoin')) $('#swapToCoin').innerHTML = shortList.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');

    // Gainers / Losers toggle
    $('#btnGainers').onclick = ()=>{ $('#btnGainers').classList.add('active'); $('#btnLosers').classList.remove('active'); showGainers(); };
    $('#btnLosers').onclick = ()=>{ $('#btnLosers').classList.add('active'); $('#btnGainers').classList.remove('active'); showLosers(); };
    // default show gainers
    showGainers();

    // nav links
    document.querySelectorAll('[data-target]').forEach(el=>el.addEventListener('click', e=>{ e.preventDefault(); const t = el.dataset.target; if(t) switchPage(t); }));

    // header buttons
    $('#getMobileAppBtn').onclick = ()=>{ $('#installPrompt').classList.remove('hide'); };
    $('#maybeLaterBtn').onclick = ()=>{ $('#installPrompt').classList.add('hide'); };
    $('#installNowBtn').onclick = async ()=>{
      if(navigator.share){ navigator.share({title:'Auto Trading Bot', url:location.href}); $('#installPrompt').classList.add('hide'); } else alert("Use your browser menu to install.");
    };

    // more links
    $('#settingsMenuBtn').onclick = ()=>{ switchPage('settingsPage'); $('#moreMenu').classList.add('hide'); };
    $('#supportBtn').onclick = ()=>{ switchPage('supportPage'); $('#moreMenu').classList.add('hide'); };

    // disconnect in menu
    $('#disconnectBtn').onclick = ()=>{ disconnectWallet(); $('#moreMenu').classList.add('hide'); };

    // theme select
    $('#themeSelect') && ($('#themeSelect').onchange = function(){ if(this.value==='light'){ document.body.style.background='#fff'; document.body.style.color='#000'; } else { document.body.style.background='var(--bg)'; document.body.style.color='#fff'; } });

    // close account
    $('#closeAccountBtn').onclick = async ()=>{ if(!confirm("Close account? This will clear local data.")) return; localStorage.clear(); location.reload(); };

    updateUIOnConnect();
  });

  /* ---------- Earnings page placeholder ---------- */
  function renderEarningsPage(){
    alert("Earnings view - summary displayed on Trade dashboard.");
  }

  /* ---------- Utility functions ---------- */
  function renderActiveTradesOnLoad(){ renderActiveTrades(); }
  // simple helper to show trading toast elsewhere
  function showSimpleToast(msg){ notify(msg); }

  /* ---------- Inline service worker registration ---------- */
  if('serviceWorker' in navigator){
    const swCode = `
      const CACHE_NAME = 'auto-trade-cache-v1';
      const ASSETS = ['./','/index.html','/app-logo.png'];
      self.addEventListener('install', event=>{ self.skipWaiting(); event.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(ASSETS)).catch(()=>{})); });
      self.addEventListener('activate', event=>{ event.waitUntil(self.clients.claim()); });
      self.addEventListener('fetch', event=>{ event.respondWith(caches.match(event.request).then(res=>res||fetch(event.request).catch(()=>caches.match('/')))); });
    `;
    const blob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).then(()=>{ console.log('SW registered from blob'); }).catch(e=>console.warn('SW register failed', e));
  }
  
const COINGECKO_API = 'https://api.coingecko.com/api/v3';
let selectedSymbol = 'bitcoin';

// Pages navigation
document.querySelectorAll('.navbar button').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active-page'));
    document.getElementById(btn.dataset.page).classList.add('active-page');
    document.getElementById('headerTitle').textContent = btn.textContent;
  };
});

// Toast notifications
function showToast(msg) {
  const t = document.createElement('div');
  t.className='toast'; t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>{t.remove();},3000);
}

// Fetch market coins
async function fetchMarketData(order='market_cap_desc', limit=50){
  const res = await fetch(`${COINGECKO_API}/coins/markets?vs_currency=usd&order=${order}&per_page=${limit}&page=1&sparkline=false`);
  return res.json();
}

async function renderMarkets(order='market_cap_desc'){
  const coins = await fetchMarketData(order);
  const container = document.getElementById('marketCoins');
  container.innerHTML='';
  coins.forEach(c=>{
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML=`<div><img src='${c.image}' width='20'> ${c.name} (${c.symbol.toUpperCase()})</div><div>$${c.current_price}</div>`;
    div.onclick=()=>{ selectedSymbol = c.id; updateTradingViewChart(selectedSymbol); };
    container.appendChild(div);
  });
}

// Render Gainers / Losers
document.getElementById('btnGainers').onclick=()=>renderMarkets('percent_change_24h_desc');
document.getElementById('btnLosers').onclick=()=>renderMarkets('percent_change_24h_asc');
// Default Gainers
renderMarkets();

// Wallet (simulate fetch wallet balances)
async function renderWallet(){
  const coins = await fetchMarketData();
  const container = document.getElementById('walletCoins');
  container.innerHTML='';
  coins.slice(0,5).forEach(c=>{
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML=`<div><img src='${c.image}' width='20'> ${c.name}</div><div>$${(c.current_price* (Math.random()*10)).toFixed(2)}</div>`;
    div.onclick=()=>{ selectedSymbol = c.id; updateTradingViewChart(selectedSymbol); };
    container.appendChild(div);
  });
}
renderWallet();

// TradingView chart
let tvWidget = null;
function updateTradingViewChart(symbol){
  const container = document.getElementById('tradeChart');
  container.innerHTML='';
  try{
    tvWidget = new TradingView.widget({
      width:'100%', height:340, symbol:`BINANCE:${symbol.toUpperCase()}USDT`, interval:'1D', timezone:'Etc/UTC', theme:'dark', style:1, locale:'en', container_id:'tradeChart', hide_side_toolbar:false
    });
  }catch(e){ container.innerHTML='Chart load error'; console.error(e);}
}
updateTradingViewChart(selectedSymbol);

// Deposit search
document.getElementById('depositSearch').oninput=async function(){
  const q=this.value.toLowerCase();
  const coins = await fetchMarketData();
  const container=document.getElementById('depositCoins');
  container.innerHTML='';
  coins.filter(c=>c.name.toLowerCase().includes(q)).forEach(c=>{
    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`<div><img src='${c.image}' width='20'> ${c.name}</div>`;
    container.appendChild(div);
  });
};

// Transactions / Activities (simulate)
function renderTransactions(){
  const container=document.getElementById('transactionsList');
  container.innerHTML='';
  for(let i=0;i<5;i++){
    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`Tx #${i+1} - Buy BTC $${(Math.random()*500).toFixed(2)} <button onclick='this.parentNode.remove()'>Delete</button>`;
    container.appendChild(div);
  }
}
function renderActivities(){
  const container=document.getElementById('activitiesList');
  container.innerHTML='';
  for(let i=0;i<5;i++){
    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`Activity #${i+1} - Trade completed <button onclick='this.parentNode.remove()'>Delete</button>`;
    container.appendChild(div);
  }
}
renderTransactions(); renderActivities();

// Support Chat Bot (simulate with AI public API)
document.getElementById('chatSendBtn').onclick=async function(){
  const input=document.getElementById('chatInput');
  const msg=input.value.trim(); if(!msg) return;
  const chat=document.getElementById('chatMessages');
  const div=document.createElement('div'); div.textContent='You: '+msg; chat.appendChild(div);
  input.value='';
  const replyDiv=document.createElement('div'); replyDiv.textContent='Support: Loading...'; chat.appendChild(replyDiv);
  // Simulated AI reply (replace with real API call)
  setTimeout(()=>{replyDiv.textContent='Support: '+msg.split('').reverse().join(''); chat.scrollTop=chat.scrollHeight;},1000);
};

// Live market notifications (CoinGecko price alerts simulation)
async function marketNotifications(){
  const coins=await fetchMarketData();
  coins.slice(0,3).forEach(c=>{
    showToast(`${c.name}: $${c.current_price}`);
  });
}
setInterval(marketNotifications,60000);
</script></body>
</html>
